<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMM Pricing Strategy Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Chart Container Styling */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            height: 300px;
            margin: 0 auto;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { height: 8px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }

        /* Table Input Styling */
        .table-input {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 4px 8px;
            width: 100%;
            transition: all 0.2s;
            font-size: 0.875rem;
            color: #0f172a;
        }
        .table-input:hover { border-color: #cbd5e1; }
        .table-input:focus { 
            border-color: #6366f1; 
            outline: none; 
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1); 
        }
        /* Align numbers to right */
        .table-input.num-input { text-align: right; font-family: 'Inter', monospace; }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.9);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            font-weight: 600; color: #6366f1;
        }

        /* Dragging Styles */
        .draggable-row.dragging { 
            opacity: 0.5; 
            background-color: #eff6ff; /* Blue-50 */
            border: 2px dashed #6366f1;
        }
        /* Only change cursor on the handle */
        .drag-handle { cursor: grab; touch-action: none; }
        .drag-handle:active { cursor: grabbing; }
    </style>
</head>
<body class="bg-[#fafaf9] text-[#1c1917] antialiased min-h-screen flex flex-col">

    <!-- AUTH SCREEN -->
    <div id="auth-container" class="fixed inset-0 z-50 flex items-center justify-center auth-bg">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden mx-4 p-8">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-slate-900">Pricing Dashboard</h1>
                <p class="text-slate-500 text-sm mt-1">Sign in to manage your pricing strategy</p>
            </div>
            <div id="auth-error" class="hidden bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4 text-center"></div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Email</label>
                    <input type="email" id="auth-email" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase">Password</label>
                    <input type="password" id="auth-password" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition">
                </div>
                <div class="pt-4 flex flex-col gap-3">
                    <button id="loginBtn" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg transition">Login</button>
                    <button id="registerBtn" class="w-full py-3 bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 rounded-xl font-bold transition">Create Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER (Hidden until logged in) -->
    <div id="app-container" class="hidden flex-grow flex flex-col w-full h-full">

        <!-- ADD ITEM MODAL -->
        <div id="addModal" class="fixed inset-0 z-[100] hidden bg-black/20 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden border border-[#e7e5e4]">
                <div class="px-6 py-4 border-b border-[#e7e5e4] flex justify-between items-center bg-[#fafaf9]">
                    <h3 class="font-bold text-lg text-[#1c1917]">Add New Service</h3>
                    <button id="closeModalBtn" class="text-[#a8a29e] hover:text-red-500 text-2xl leading-none">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="col-span-1">
                            <label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">ID</label>
                            <input type="number" id="newId" placeholder="101" class="w-full p-2 border border-[#e7e5e4] rounded-lg focus:border-[#6366f1] focus:ring-1 focus:ring-[#6366f1] outline-none">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Platform</label>
                            <input type="text" id="newPlatform" placeholder="e.g., YouTube" class="w-full p-2 border border-[#e7e5e4] rounded-lg focus:border-[#6366f1] focus:ring-1 focus:ring-[#6366f1] outline-none">
                        </div>
                    </div>
                    
                    <!-- NEW CATEGORY INPUT -->
                    <div>
                        <label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Category (Followers, Likes...)</label>
                        <div class="relative">
                            <input type="text" id="newCategory" list="categorySuggestions" placeholder="Select or type..." class="w-full p-2 border border-[#e7e5e4] rounded-lg focus:border-[#6366f1] focus:ring-1 focus:ring-[#6366f1] outline-none">
                            <datalist id="categorySuggestions">
                                <option value="Followers">
                                <option value="Likes">
                                <option value="Views">
                                <option value="Comments">
                                <option value="Shares">
                                <option value="Subscribers">
                            </datalist>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Service Name</label>
                        <input type="text" id="newService" placeholder="e.g., 1k High Quality" class="w-full p-2 border border-[#e7e5e4] rounded-lg focus:border-[#6366f1] focus:ring-1 focus:ring-[#6366f1] outline-none">
                    </div>
                    
                    <!-- NEW LINK INPUT -->
                    <div>
                        <label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Provider Link (Secsers)</label>
                        <input type="url" id="newLink" placeholder="https://secsers.com/services/..." class="w-full p-2 border border-[#e7e5e4] rounded-lg focus:border-[#6366f1] focus:ring-1 focus:ring-[#6366f1] outline-none text-blue-600">
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Cost ($)</label>
                            <input type="number" id="newCost" step="0.01" placeholder="0.00" class="w-full p-2 border border-[#e7e5e4] rounded-lg focus:border-[#6366f1] focus:ring-1 focus:ring-[#6366f1] outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Sell (DA)</label>
                            <input type="number" id="newSell" step="10" placeholder="0" class="w-full p-2 border border-[#e7e5e4] rounded-lg focus:border-[#6366f1] focus:ring-1 focus:ring-[#6366f1] outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Qty</label>
                            <input type="number" id="newQty" step="1" value="1" class="w-full p-2 border border-[#e7e5e4] rounded-lg focus:border-[#6366f1] focus:ring-1 focus:ring-[#6366f1] outline-none">
                        </div>
                    </div>
                </div>
                <div class="px-6 py-4 bg-[#fafaf9] flex justify-end gap-3 border-t border-[#e7e5e4]">
                    <button id="cancelModalBtn" class="px-4 py-2 text-sm font-medium text-[#57534e] hover:bg-[#e7e5e4] rounded-lg transition">Cancel</button>
                    <button id="saveServiceBtn" class="px-4 py-2 text-sm font-bold text-white bg-[#6366f1] hover:bg-[#4f46e5] rounded-lg shadow-sm transition">Save Service</button>
                </div>
            </div>
        </div>

        <!-- HEADER & CONTROLS -->
        <header class="bg-white border-b border-[#e7e5e4] sticky top-0 z-50 shadow-sm">
            <!-- EXPANDED WIDTH: max-w-[98%] -->
            <div class="max-w-[98%] mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h1 class="text-2xl font-bold tracking-tight text-[#1c1917]">Pricing Strategy <span class="text-[#6366f1]">Dashboard</span></h1>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs text-[#57534e] font-medium bg-[#f5f5f4] px-2 py-0.5 rounded" id="userEmailDisplay">...</span>
                            <button id="logoutBtn" class="text-xs text-red-500 hover:text-red-700 font-bold underline">Logout</button>
                        </div>
                    </div>
                    
                    <!-- Interactive Control: Exchange Rate -->
                    <div class="bg-[#f5f5f4] rounded-lg p-3 flex items-center gap-4 border border-[#e7e5e4]">
                        <div class="text-sm font-semibold text-[#57534e] uppercase tracking-wider">USD to DA Rate</div>
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-mono text-[#a8a29e]">200</span>
                            <input type="range" id="rateSlider" min="200" max="300" value="255" step="1" class="w-32 h-2 bg-[#d6d3d1] rounded-lg appearance-none cursor-pointer accent-[#6366f1]">
                            <span class="text-xs font-mono text-[#a8a29e]">300</span>
                        </div>
                        <div class="bg-white px-3 py-1 rounded border border-[#e7e5e4] font-mono font-bold text-[#6366f1]" id="rateDisplay">255.0</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- EXPANDED WIDTH: max-w-[98%] -->
        <main class="flex-grow max-w-[98%] mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full space-y-8">

            <!-- KPI CARDS -->
            <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-[#e7e5e4] flex flex-col justify-between">
                    <div class="text-xs font-bold text-[#a8a29e] uppercase mb-1">Total Portfolio Value (Sell)</div>
                    <div class="text-3xl font-bold text-[#1c1917]" id="kpi-revenue">0 DA</div>
                    <div class="text-xs text-[#57534e] mt-2">Total revenue from all quantities</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-[#e7e5e4] flex flex-col justify-between">
                    <div class="text-xs font-bold text-[#a8a29e] uppercase mb-1">Total Est. Profit</div>
                    <div class="text-3xl font-bold text-[#6366f1]" id="kpi-profit">0 DA</div>
                    <div class="text-xs text-[#57534e] mt-2">Net earnings at current exchange rate</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-[#e7e5e4] flex flex-col justify-between">
                    <div class="text-xs font-bold text-[#a8a29e] uppercase mb-1">Avg. Profit Margin</div>
                    <div class="text-3xl font-bold text-emerald-600" id="kpi-margin">0%</div>
                    <div class="text-xs text-[#57534e] mt-2">Average ROI across your portfolio</div>
                </div>
            </section>

            <!-- ANALYTICS SECTION -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Chart 1: Arbitrage Analysis -->
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-[#e7e5e4]">
                    <div class="mb-6 flex justify-between items-end">
                        <div>
                            <h3 class="text-lg font-bold text-[#1c1917]">Arbitrage Gap Analysis</h3>
                            <p class="text-sm text-[#78716c]">Cost Basis vs. Selling Price (Top Profitable Items)</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="arbitrageChart"></canvas>
                    </div>
                </div>

                <!-- Chart 2: Portfolio Mix -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-[#e7e5e4]">
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-[#1c1917]">Platform Mix</h3>
                        <p class="text-sm text-[#78716c]">Distribution of services.</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- DATA EXPLORER (EDITABLE) -->
            <section class="bg-white rounded-xl shadow-sm border border-[#e7e5e4] overflow-hidden">
                <div class="p-6 border-b border-[#e7e5e4] flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <div>
                        <h3 class="text-lg font-bold text-[#1c1917]">Service Ledger</h3>
                        <p class="text-sm text-[#78716c]">Drag <span class="font-bold bg-gray-100 px-1 rounded">=</span> to reorder items. Edit details directly.</p>
                    </div>
                    <div class="flex gap-3 items-center">
                        <div id="filterContainer" class="flex gap-2">
                            <!-- Filters injected by JS -->
                        </div>
                        <div class="h-6 w-px bg-[#e7e5e4] mx-1"></div>
                        <button id="openModalBtn" class="flex items-center gap-2 px-4 py-2 text-sm font-bold text-white bg-[#1c1917] hover:bg-[#57534e] rounded-lg transition shadow-sm">
                            <span>+ Add Service</span>
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto custom-scroll pb-4">
                    <table class="w-full text-left text-sm" id="serviceTable">
                        <thead class="bg-[#fafaf9] text-[#57534e] font-semibold uppercase text-xs tracking-wider border-b border-[#e7e5e4]">
                            <tr>
                                <!-- DRAG HANDLE COL -->
                                <th class="w-8 px-2 py-3"></th>
                                <th class="px-3 py-3 w-20 text-center">ID</th>
                                <th class="px-3 py-3 whitespace-nowrap min-w-[140px]">Platform</th>
                                <!-- NEW CATEGORY COLUMN -->
                                <th class="px-3 py-3 whitespace-nowrap min-w-[140px]">Category</th>
                                <th class="px-3 py-3 whitespace-nowrap min-w-[220px]">Service Name</th>
                                <th class="px-3 py-3 text-right whitespace-nowrap w-24">Cost ($)</th>
                                <th class="px-3 py-3 text-right bg-red-50/50 text-red-800 whitespace-nowrap w-24">Cost (DA)</th>
                                <th class="px-3 py-3 text-right bg-blue-50/50 text-blue-800 whitespace-nowrap w-24">Sell ($)</th>
                                <th class="px-3 py-3 text-right bg-green-50/50 text-green-800 whitespace-nowrap w-24">Sell (DA)</th>
                                <th class="px-3 py-3 text-center w-16">Qty</th>
                                <th class="px-3 py-3 text-right whitespace-nowrap">Profit (DA)</th>
                                <th class="px-3 py-3 text-right whitespace-nowrap">Margin</th>
                                <th class="px-3 py-3 w-32 text-right">Actions</th> <!-- Increased Width -->
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-[#e7e5e4]" id="tableBody">
                            <!-- Populated by JS -->
                        </tbody>
                        <tfoot class="bg-[#f5f5f4] font-bold text-[#1c1917] border-t-2 border-[#e7e5e4]">
                            <tr>
                                <td class="px-3 py-3"></td> <!-- Spacer for Handle -->
                                <td colspan="4" class="px-3 py-3 text-right text-[#a8a29e] uppercase text-xs tracking-wider">Totals:</td>
                                
                                <td class="px-3 py-3 text-right font-mono text-[#57534e]" id="foot-cost-usd">0.00</td>
                                <td class="px-3 py-3 text-right font-mono text-red-800 bg-red-50/50" id="foot-cost">0</td>
                                <td class="px-3 py-3 text-right font-mono text-blue-800 bg-blue-50/50" id="foot-sell-usd">0.00</td>
                                <td class="px-3 py-3 text-right font-mono text-green-800 bg-green-50/50" id="foot-rev">0</td>
                                <td class="px-3 py-3 text-center font-mono" id="foot-qty">0</td>
                                <td class="px-3 py-3 text-right font-mono text-indigo-600 text-base" id="foot-profit">0</td>
                                <td class="px-3 py-3 text-right font-mono text-xs" id="foot-margin">0%</td>
                                <td class="px-3 py-3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </section>

            <footer class="bg-white border-t border-[#e7e5e4] py-8 mt-auto">
                <!-- EXPANDED WIDTH: max-w-[98%] -->
                <div class="max-w-[98%] mx-auto px-4 text-center">
                    <p class="text-sm text-[#a8a29e]">&copy; 2025 Interactive Pricing Dashboard.</p>
                </div>
            </footer>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyCdB5SZ9Xi6MVZl-DsmTgWjJPK5EId-4F8",
          authDomain: "dized-box.firebaseapp.com",
          projectId: "dized-box",
          storageBucket: "dized-box.firebasestorage.app",
          messagingSenderId: "163199308320",
          appId: "1:163199308320:web:7e8217dabae7668d016245",
          measurementId: "G-Q9GFSXFZG8"
        };
        const appId = 'SMM_Pricing_Dashboard_App';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let userId = null;
        let serviceData = [];
        let currentRate = 255;
        let activeFilter = 'all';
        let arbChart = null;
        let distChart = null;
        // Drag State
        let dragSrcEl = null;
        let dragSrcIndex = -1;

        // --- DOM REFERENCES ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const authError = document.getElementById('auth-error');

        const slider = document.getElementById('rateSlider');
        const rateDisplay = document.getElementById('rateDisplay');
        const tableBody = document.getElementById('tableBody');
        const filterContainer = document.getElementById('filterContainer');
        
        // Modal
        const addModal = document.getElementById('addModal');
        const newIdInput = document.getElementById('newId');
        const newCategoryInput = document.getElementById('newCategory');
        
        // Footer & KPIs
        const kpiRevenue = document.getElementById('kpi-revenue');
        const kpiProfit = document.getElementById('kpi-profit');
        const kpiMargin = document.getElementById('kpi-margin');
        const footCostUSD = document.getElementById('foot-cost-usd');
        const footCost = document.getElementById('foot-cost');
        const footSellUSD = document.getElementById('foot-sell-usd');
        const footRev = document.getElementById('foot-rev');
        const footQty = document.getElementById('foot-qty');
        const footProfit = document.getElementById('foot-profit');
        const footMargin = document.getElementById('foot-margin');

        // --- INIT ---
        window.addEventListener('load', () => {
            initCharts();
            setupEventListeners();
        });

        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userEmailDisplay.textContent = user.email;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                setupRealtimeListeners();
            } else {
                userId = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                serviceData = []; 
            }
        });

        async function handleLogin() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-password').value;
            authError.classList.add('hidden');
            try { await signInWithEmailAndPassword(auth, email, pass); } catch (error) {
                authError.textContent = "Login Failed: " + error.message;
                authError.classList.remove('hidden');
            }
        }

        async function handleRegister() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-password').value;
            authError.classList.add('hidden');
            try { await createUserWithEmailAndPassword(auth, email, pass); } catch (error) {
                authError.textContent = "Registration Failed: " + error.message;
                authError.classList.remove('hidden');
            }
        }

        function handleLogout() { signOut(auth); }

        // --- REALTIME DATA SYNC ---
        function setupRealtimeListeners() {
            if (!userId) return;

            const servicesRef = collection(db, 'artifacts', appId, 'users', userId, 'services');
            const settingsDoc = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'global');

            onSnapshot(servicesRef, (snapshot) => {
                serviceData = [];
                snapshot.forEach(doc => {
                    serviceData.push({ ...doc.data(), docId: doc.id });
                });
                
                // Sort by sortOrder, then by createdAt fallback
                serviceData.sort((a, b) => {
                    const orderA = a.sortOrder !== undefined ? a.sortOrder : (a.createdAt || 0);
                    const orderB = b.sortOrder !== undefined ? b.sortOrder : (b.createdAt || 0);
                    return orderA - orderB;
                });
                
                updateDashboard();
                updateFilterButtons();
            }, (error) => console.error("Data sync error:", error));

            onSnapshot(settingsDoc, (docSnap) => {
                if (docSnap.exists()) {
                    currentRate = docSnap.data().rate || 255;
                    slider.value = currentRate;
                    rateDisplay.textContent = currentRate.toFixed(1);
                    updateDashboard();
                } else {
                    setDoc(settingsDoc, { rate: 255 }, { merge: true });
                }
            });
        }

        // --- DRAG AND DROP LOGIC (RESTRICTED TO HANDLE) ---
        function addDragEvents(row, index) {
            // IMPORTANT: DO NOT set draggable="true" here initially.
            // We only set it when the handle is moused over/down.
            row.setAttribute('draggable', 'false');
            row.dataset.index = index;

            const handle = row.querySelector('.drag-handle');
            
            // RESTRICT DRAGGING: Only enable dragging when interacting with the handle
            handle.addEventListener('mouseenter', () => row.setAttribute('draggable', 'true'));
            handle.addEventListener('mouseleave', () => row.setAttribute('draggable', 'false'));
            
            // Mobile touch support is trickier, but for mouse this is robust:
            handle.addEventListener('mousedown', () => row.setAttribute('draggable', 'true'));
            
            row.addEventListener('dragstart', (e) => {
                // Double check target (redundant but safe)
                dragSrcEl = row;
                dragSrcIndex = index;
                row.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', index);
            });

            row.addEventListener('dragover', (e) => {
                if (e.preventDefault) e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                return false;
            });

            row.addEventListener('dragenter', (e) => {
                row.classList.add('bg-indigo-50');
            });

            row.addEventListener('dragleave', (e) => {
                row.classList.remove('bg-indigo-50');
            });

            row.addEventListener('dragend', () => {
                row.classList.remove('dragging');
                row.setAttribute('draggable', 'false'); // Reset after drag
                const rows = tableBody.querySelectorAll('tr');
                rows.forEach(r => r.classList.remove('bg-indigo-50'));
            });

            row.addEventListener('drop', async (e) => {
                if (e.stopPropagation) e.stopPropagation();
                const targetIndex = parseInt(row.dataset.index);
                if (dragSrcIndex !== targetIndex && dragSrcIndex > -1) {
                    await reorderItems(dragSrcIndex, targetIndex);
                }
                return false;
            });
        }

        async function reorderItems(fromIndex, toIndex) {
            const itemMoved = serviceData.splice(fromIndex, 1)[0];
            serviceData.splice(toIndex, 0, itemMoved);

            const batch = writeBatch(db);
            
            serviceData.forEach((item, index) => {
                item.sortOrder = index;
                if (item.docId) {
                    const ref = doc(db, 'artifacts', appId, 'users', userId, 'services', item.docId);
                    batch.update(ref, { sortOrder: index });
                }
            });

            try {
                await batch.commit();
            } catch(err) {
                console.error("Reorder failed", err);
                alert("Failed to reorder");
            }
        }

        // --- CRUD ACTIONS ---
        window.saveNewService = async () => {
            if (!userId) return;
            const customId = parseInt(newIdInput.value) || 0; 
            const platform = document.getElementById('newPlatform').value.trim();
            const category = document.getElementById('newCategory').value.trim(); 
            const service = document.getElementById('newService').value.trim();
            const cost = parseFloat(document.getElementById('newCost').value);
            const sell = parseFloat(document.getElementById('newSell').value);
            const qty = parseInt(document.getElementById('newQty').value) || 1;
            const link = document.getElementById('newLink').value.trim();

            if (!platform || !service || isNaN(cost) || isNaN(sell)) {
                alert("Please fill in all fields correctly.");
                return;
            }

            const sortOrder = serviceData.length;

            const newItem = { 
                customId: customId, 
                platform, 
                category,
                service, 
                buyUSD: cost, 
                sellDA: sell, 
                qty, 
                link,
                sortOrder: sortOrder, 
                createdAt: Date.now()
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'services'), newItem);
                closeAddModal();
            } catch (e) {
                console.error("Error saving:", e);
                alert("Failed to save.");
            }
        };

        // NEW: DUPLICATE FUNCTION
        window.duplicateService = async (docId) => {
            if (!userId) return;
            const original = serviceData.find(s => s.docId === docId);
            if (!original) return;

            // Calculate new Custom ID
            const maxId = serviceData.length > 0 ? Math.max(...serviceData.map(s => s.customId || 0)) : 100;
            const newCustomId = maxId + 1;

            const newItem = {
                ...original,
                customId: newCustomId,
                service: original.service + " (Copy)",
                createdAt: Date.now(),
                sortOrder: serviceData.length // Put at end
            };
            delete newItem.docId; // Ensure we don't copy the document ID

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'services'), newItem);
            } catch (e) {
                console.error("Duplicate failed", e);
            }
        };

        window.updateValue = async (docId, field, value) => {
            if (!userId) return;
            
            let updateVal = value;
            
            if(['buyUSD', 'sellDA', 'qty', 'customId'].includes(field)) {
                const numVal = parseFloat(value);
                if (isNaN(numVal)) return;
                updateVal = numVal;
            }

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'services', docId), {
                    [field]: updateVal
                });
            } catch (e) { console.error("Update failed:", e); }
        };

        window.deleteService = async (docId) => {
            if (!userId) return;
            if (confirm('Delete this service permanently?')) {
                try { await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'services', docId)); } 
                catch (e) { console.error("Delete failed:", e); }
            }
        };

        // --- UI & EVENTS ---
        function setupEventListeners() {
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('registerBtn').addEventListener('click', handleRegister);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            slider.addEventListener('input', (e) => {
                const val = parseInt(e.target.value);
                rateDisplay.textContent = val.toFixed(1);
                currentRate = val;
                updateDashboard();
                if (userId) {
                    setDoc(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'global'), { rate: val }, { merge: true });
                }
            });

            document.getElementById('openModalBtn').onclick = openAddModal;
            document.getElementById('closeModalBtn').onclick = closeAddModal;
            document.getElementById('cancelModalBtn').onclick = closeAddModal;
            document.getElementById('saveServiceBtn').onclick = window.saveNewService;
        }

        function openAddModal() {
            addModal.classList.remove('hidden');
            const maxId = serviceData.length > 0 ? Math.max(...serviceData.map(s => s.customId || 0)) : 100;
            newIdInput.value = maxId + 1;
        }

        function closeAddModal() {
            addModal.classList.add('hidden');
            document.getElementById('newPlatform').value = '';
            document.getElementById('newCategory').value = ''; 
            document.getElementById('newService').value = '';
            document.getElementById('newCost').value = '';
            document.getElementById('newSell').value = '';
            document.getElementById('newQty').value = '1';
            document.getElementById('newLink').value = ''; 
        }

        // --- DASHBOARD CALCULATION ---
        function updateDashboard() {
            let totalRev = 0;
            let totalProfit = 0;
            let totalCost = 0;
            let totalQty = 0;
            let totalCostUSD = 0;
            let totalSellUSD_Calc = 0;
            
            const processedData = serviceData.map(item => {
                const displayId = item.customId !== undefined ? item.customId : 0;
                const qty = item.qty || 0;
                const costDA_Unit = item.buyUSD * currentRate;
                const costDA_Total = costDA_Unit * qty;
                const sellDA_Unit = item.sellDA;
                const sellDA_Total = sellDA_Unit * qty;
                const profitDA_Total = sellDA_Total - costDA_Total;
                const margin = sellDA_Total > 0 ? (profitDA_Total / sellDA_Total) * 100 : 0;
                const sellUSD_Unit = currentRate > 0 ? sellDA_Unit / currentRate : 0;
                const docId = item.docId || ''; 
                
                return { ...item, displayId, costDA_Unit, costDA_Total, sellDA_Unit, sellDA_Total, profitDA_Total, margin, sellUSD_Unit, docId };
            });

            const visibleData = renderTable(processedData);

            visibleData.forEach(item => {
                totalRev += item.sellDA_Total;
                totalProfit += item.profitDA_Total;
                totalCost += item.costDA_Total;
                totalQty += item.qty;
                totalCostUSD += (item.buyUSD * item.qty);
                totalSellUSD_Calc += (item.sellUSD_Unit * item.qty);
            });

            kpiRevenue.textContent = totalRev.toLocaleString() + ' DA';
            kpiProfit.textContent = totalProfit.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0}) + ' DA';
            const globalMargin = totalRev > 0 ? (totalProfit / totalRev) * 100 : 0;
            kpiMargin.textContent = globalMargin.toFixed(1) + '%';
            kpiMargin.className = `text-3xl font-bold ${globalMargin >= 0 ? 'text-emerald-600' : 'text-red-600'}`;

            footCostUSD.innerText = '$' + totalCostUSD.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            footCost.innerText = totalCost.toLocaleString(undefined, {maximumFractionDigits: 0});
            footRev.innerText = totalRev.toLocaleString(undefined, {maximumFractionDigits: 0});
            footSellUSD.innerText = '$' + totalSellUSD_Calc.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            footQty.innerText = totalQty.toLocaleString();
            footProfit.innerText = totalProfit.toLocaleString(undefined, {maximumFractionDigits: 0});
            footMargin.innerText = globalMargin.toFixed(1) + '%';
            footMargin.className = `px-3 py-3 text-right font-mono text-xs font-bold ${globalMargin >= 0 ? 'text-emerald-600' : 'text-red-600'}`;

            updateCharts(visibleData);
        }

        function renderTable(data) {
            tableBody.innerHTML = '';
            const filtered = activeFilter === 'all' ? data : data.filter(d => d.platform === activeFilter);

            if (filtered.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="13" class="px-6 py-8 text-center text-[#a8a29e]">No services found. Add one to get started.</td></tr>';
                return [];
            }

            filtered.forEach((item, index) => {
                const docId = item.docId; 

                let actionButtons = '';
                if (item.link && item.link.trim() !== '') {
                    actionButtons += `
                        <a href="${item.link}" target="_blank" class="text-blue-600 hover:text-blue-800 bg-blue-50 p-1.5 rounded-md hover:bg-blue-100 transition" title="Buy on Secsers">
                            <span class="font-bold text-xs">â†—</span>
                        </a>
                    `;
                }
                // NEW: Duplicate Button
                actionButtons += `
                    <button onclick="window.duplicateService('${docId}')" class="text-indigo-400 hover:text-indigo-600 p-1.5 rounded-md hover:bg-indigo-50 transition" title="Duplicate">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    </button>
                `;
                actionButtons += `
                    <button onclick="window.deleteService('${docId}')" class="text-slate-400 hover:text-red-500 p-1.5 rounded-md hover:bg-red-50 transition" title="Delete">
                        <span class="font-bold text-lg leading-none">&times;</span>
                    </button>
                `;

                const row = document.createElement('tr');
                row.className = 'hover:bg-[#f5f5f4] transition group border-b border-[#f5f5f4] last:border-0 draggable-row';
                row.innerHTML = `
                    <td class="px-2 py-2 text-center drag-handle text-slate-400 hover:text-slate-600">
                        <svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path></svg>
                    </td>
                    <td class="px-3 py-2 text-center font-mono text-[#a8a29e] text-xs">
                        <input type="number" value="${item.displayId}" 
                            onchange="window.updateValue('${docId}', 'customId', this.value)"
                            class="table-input num-input text-center w-24 text-[#a8a29e]">
                    </td>
                    <td class="px-3 py-2 font-medium text-[#1c1917]">
                        <input type="text" value="${item.platform}" 
                            onchange="window.updateValue('${docId}', 'platform', this.value)"
                            class="table-input w-full text-[#1c1917] font-medium">
                    </td>
                    <td class="px-3 py-2 text-[#57534e]">
                        <input type="text" value="${item.category || ''}" 
                            onchange="window.updateValue('${docId}', 'category', this.value)"
                            class="table-input w-full text-[#57534e]">
                    </td>
                    <td class="px-3 py-2 text-[#57534e]">
                        <input type="text" value="${item.service}" 
                            onchange="window.updateValue('${docId}', 'service', this.value)"
                            class="table-input w-full text-[#57534e]">
                    </td>
                    <td class="px-3 py-2 text-right font-mono text-[#a8a29e]">
                        <div class="flex items-center justify-end gap-1">
                            <span class="text-xs text-gray-400">$</span>
                            <input type="number" value="${item.buyUSD}" step="0.01" 
                                onchange="window.updateValue('${docId}', 'buyUSD', this.value)"
                                class="table-input num-input font-mono w-20">
                        </div>
                    </td>
                    <td class="px-3 py-2 text-right font-mono font-bold text-red-700 bg-red-50/30">${item.costDA_Unit.toFixed(0)}</td>
                    
                    <td class="px-3 py-2 text-right font-mono font-bold text-blue-700 bg-blue-50/30">
                        <div class="flex items-center justify-end gap-1">
                            <span class="text-xs opacity-60">$</span>
                            <span>${item.sellUSD_Unit.toFixed(2)}</span>
                        </div>
                    </td>

                    <td class="px-3 py-2 text-right">
                         <div class="flex items-center justify-end gap-1 bg-green-50/30 rounded px-2">
                            <input type="number" value="${item.sellDA}" step="10" 
                                onchange="window.updateValue('${docId}', 'sellDA', this.value)"
                                class="table-input num-input font-mono font-bold text-green-700 bg-transparent w-20">
                            <span class="text-xs text-green-700 font-bold">DA</span>
                        </div>
                    </td>
                    <td class="px-3 py-2 text-center">
                        <input type="number" value="${item.qty}" step="1" min="0"
                                onchange="window.updateValue('${docId}', 'qty', this.value)"
                                class="table-input num-input font-mono text-center w-16 bg-[#e5e7eb]/50 focus:bg-white border-b border-gray-300">
                    </td>
                    <td class="px-3 py-2 text-right font-mono font-bold ${item.profitDA_Total >= 0 ? 'text-[#1c1917]' : 'text-red-600'}">${item.profitDA_Total.toFixed(0)}</td>
                    <td class="px-3 py-2 text-right font-mono text-xs ${item.margin >= 0 ? 'text-emerald-600' : 'text-red-600'}">${item.margin.toFixed(1)}%</td>
                    <td class="px-3 py-2 text-right">
                        <div class="flex justify-end gap-2 items-center">
                            ${actionButtons}
                        </div>
                    </td>
                `;
                
                addDragEvents(row, index);
                tableBody.appendChild(row);
            });
            return filtered;
        }

        function updateFilterButtons() {
            const platforms = ['all', ...new Set(serviceData.map(item => item.platform))];
            filterContainer.innerHTML = '';
            platforms.forEach(p => {
                const btn = document.createElement('button');
                const isActive = activeFilter === p;
                btn.textContent = p === 'all' ? 'All' : p;
                btn.onclick = () => { activeFilter = p; updateFilterButtons(); updateDashboard(); };
                btn.className = `px-3 py-1.5 text-sm font-medium rounded-md transition capitalize ${
                    isActive ? 'bg-[#1c1917] text-white shadow-md' : 'bg-white border border-[#e7e5e4] text-[#57534e] hover:bg-[#f5f5f4]'
                }`;
                filterContainer.appendChild(btn);
            });
        }

        function initCharts() {
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.color = '#78716c';
            const ctxArb = document.getElementById('arbitrageChart').getContext('2d');
            arbChart = new Chart(ctxArb, {
                type: 'bar',
                data: { labels: [], datasets: [ { label: 'Total Cost (DA)', data: [], backgroundColor: '#e5e5e5', borderRadius: 4 }, { label: 'Total Revenue (DA)', data: [], backgroundColor: '#6366f1', borderRadius: 4 } ] },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'top', align: 'end' } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true, grid: { borderDash: [4, 4] } } } }
            });

            const ctxDist = document.getElementById('distributionChart').getContext('2d');
            distChart = new Chart(ctxDist, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: ['#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe', '#e0e7ff'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } }, cutout: '75%' }
            });
        }

        function updateCharts(data) {
            const topItems = [...data].sort((a, b) => b.profitDA_Total - a.profitDA_Total).slice(0, 6);
            arbChart.data.labels = topItems.map(d => d.service.length > 15 ? d.service.substring(0,15)+'...' : d.service);
            arbChart.data.datasets[0].data = topItems.map(d => d.costDA_Total);
            arbChart.data.datasets[1].data = topItems.map(d => d.sellDA_Total);
            arbChart.update();

            const platforms = [...new Set(data.map(d => d.platform))];
            const counts = platforms.map(p => data.filter(d => d.platform === p).length);
            distChart.data.labels = platforms;
            distChart.data.datasets[0].data = counts;
            distChart.update();
        }
    </script>
</body>
</html>
