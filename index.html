<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMM Pricing Strategy Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Chart Container Styling */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            height: 300px;
            margin: 0 auto;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        /* Custom Scrollbar for Table */
        .custom-scroll::-webkit-scrollbar { height: 8px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }

        /* Table Input Styling */
        .table-input {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 4px;
            width: 100%;
            text-align: right;
            transition: all 0.2s;
        }
        .table-input:hover { border-color: #e7e5e4; background-color: white; }
        .table-input:focus { 
            border-color: #6366f1; 
            background-color: white; 
            outline: none; 
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1); 
        }
    </style>
</head>
<body class="bg-[#fafaf9] text-[#1c1917] antialiased min-h-screen flex flex-col">

    <!-- ADD ITEM MODAL -->
    <div id="addModal" class="fixed inset-0 z-[100] hidden bg-black/20 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden border border-[#e7e5e4]">
            <div class="px-6 py-4 border-b border-[#e7e5e4] flex justify-between items-center bg-[#fafaf9]">
                <h3 class="font-bold text-lg text-[#1c1917]">Add New Service</h3>
                <button onclick="closeAddModal()" class="text-[#a8a29e] hover:text-red-500 text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-1">
                        <label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">ID</label>
                        <input type="number" id="newId" placeholder="Auto" class="w-full p-2 border border-[#e7e5e4] rounded-lg focus:border-[#6366f1] focus:ring-1 focus:ring-[#6366f1] outline-none">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Platform</label>
                        <input type="text" id="newPlatform" placeholder="e.g., YouTube" class="w-full p-2 border border-[#e7e5e4] rounded-lg focus:border-[#6366f1] focus:ring-1 focus:ring-[#6366f1] outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Service Name</label>
                    <input type="text" id="newService" placeholder="e.g., 1k Views" class="w-full p-2 border border-[#e7e5e4] rounded-lg focus:border-[#6366f1] focus:ring-1 focus:ring-[#6366f1] outline-none">
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Cost ($)</label>
                        <input type="number" id="newCost" step="0.01" placeholder="0.00" class="w-full p-2 border border-[#e7e5e4] rounded-lg focus:border-[#6366f1] focus:ring-1 focus:ring-[#6366f1] outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Sell (DA)</label>
                        <input type="number" id="newSell" step="10" placeholder="0" class="w-full p-2 border border-[#e7e5e4] rounded-lg focus:border-[#6366f1] focus:ring-1 focus:ring-[#6366f1] outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Qty</label>
                        <input type="number" id="newQty" step="1" value="1" class="w-full p-2 border border-[#e7e5e4] rounded-lg focus:border-[#6366f1] focus:ring-1 focus:ring-[#6366f1] outline-none">
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 bg-[#fafaf9] flex justify-end gap-3 border-t border-[#e7e5e4]">
                <button onclick="closeAddModal()" class="px-4 py-2 text-sm font-medium text-[#57534e] hover:bg-[#e7e5e4] rounded-lg transition">Cancel</button>
                <button onclick="saveNewService()" class="px-4 py-2 text-sm font-bold text-white bg-[#6366f1] hover:bg-[#4f46e5] rounded-lg shadow-sm transition">Save Service</button>
            </div>
        </div>
    </div>

    <!-- HEADER & CONTROLS -->
    <header class="bg-white border-b border-[#e7e5e4] sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold tracking-tight text-[#1c1917]">Pricing Strategy <span class="text-[#6366f1]">Dashboard</span></h1>
                    <p class="text-sm text-[#57534e]">Interactive Editor: Manage & Analyze Portfolio</p>
                </div>
                
                <!-- Interactive Control: Exchange Rate -->
                <div class="bg-[#f5f5f4] rounded-lg p-3 flex items-center gap-4 border border-[#e7e5e4]">
                    <div class="text-sm font-semibold text-[#57534e] uppercase tracking-wider">USD to DA Rate</div>
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-mono text-[#a8a29e]">200</span>
                        <input type="range" id="rateSlider" min="200" max="300" value="255" step="1" class="w-32 h-2 bg-[#d6d3d1] rounded-lg appearance-none cursor-pointer accent-[#6366f1]">
                        <span class="text-xs font-mono text-[#a8a29e]">300</span>
                    </div>
                    <div class="bg-white px-3 py-1 rounded border border-[#e7e5e4] font-mono font-bold text-[#6366f1]" id="rateDisplay">255.0</div>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full space-y-8">

        <!-- KPI CARDS -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-[#e7e5e4] flex flex-col justify-between">
                <div class="text-xs font-bold text-[#a8a29e] uppercase mb-1">Total Portfolio Value (Sell)</div>
                <div class="text-3xl font-bold text-[#1c1917]" id="kpi-revenue">0 DA</div>
                <div class="text-xs text-[#57534e] mt-2">Total revenue from all quantities</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-[#e7e5e4] flex flex-col justify-between">
                <div class="text-xs font-bold text-[#a8a29e] uppercase mb-1">Total Est. Profit</div>
                <div class="text-3xl font-bold text-[#6366f1]" id="kpi-profit">0 DA</div>
                <div class="text-xs text-[#57534e] mt-2">Net earnings at current exchange rate</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-[#e7e5e4] flex flex-col justify-between">
                <div class="text-xs font-bold text-[#a8a29e] uppercase mb-1">Avg. Profit Margin</div>
                <div class="text-3xl font-bold text-emerald-600" id="kpi-margin">0%</div>
                <div class="text-xs text-[#57534e] mt-2">Average ROI across your portfolio</div>
            </div>
        </section>

        <!-- ANALYTICS SECTION -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Chart 1: Arbitrage Analysis -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-[#e7e5e4]">
                <div class="mb-6 flex justify-between items-end">
                    <div>
                        <h3 class="text-lg font-bold text-[#1c1917]">Arbitrage Gap Analysis</h3>
                        <p class="text-sm text-[#78716c]">Cost Basis vs. Selling Price (Top Profitable Items)</p>
                    </div>
                    <button onclick="resetData()" class="text-xs text-[#a8a29e] hover:text-red-500 underline">Reset Data</button>
                </div>
                <div class="chart-container">
                    <canvas id="arbitrageChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: Portfolio Mix -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-[#e7e5e4]">
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-[#1c1917]">Platform Mix</h3>
                    <p class="text-sm text-[#78716c]">Distribution of services.</p>
                </div>
                <div class="chart-container">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>
        </section>

        <!-- DATA EXPLORER (EDITABLE) -->
        <section class="bg-white rounded-xl shadow-sm border border-[#e7e5e4] overflow-hidden">
            <div class="p-6 border-b border-[#e7e5e4] flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div>
                    <h3 class="text-lg font-bold text-[#1c1917]">Service Ledger</h3>
                    <p class="text-sm text-[#78716c]">Edit Quantity, Cost, or Sell Price to simulate profit.</p>
                </div>
                <div class="flex gap-3 items-center">
                    <div id="filterContainer" class="flex gap-2">
                        <!-- Filters injected by JS -->
                    </div>
                    <div class="h-6 w-px bg-[#e7e5e4] mx-1"></div>
                    <button onclick="openAddModal()" class="flex items-center gap-2 px-4 py-2 text-sm font-bold text-white bg-[#1c1917] hover:bg-[#57534e] rounded-lg transition shadow-sm">
                        <span>+ Add Service</span>
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto custom-scroll pb-4">
                <table class="w-full text-left text-sm" id="serviceTable">
                    <thead class="bg-[#fafaf9] text-[#57534e] font-semibold uppercase text-xs tracking-wider border-b border-[#e7e5e4]">
                        <tr>
                            <!-- INCREASED WIDTH HERE -->
                            <th class="px-6 py-4 w-28 text-center">ID</th>
                            <th class="px-6 py-4 whitespace-nowrap">Platform</th>
                            <th class="px-6 py-4 whitespace-nowrap">Service Name</th>
                            <th class="px-6 py-4 text-right whitespace-nowrap w-28">Cost ($)</th>
                            <th class="px-6 py-4 text-right bg-red-50/30 text-red-800 whitespace-nowrap w-28">Cost (DA)</th>
                            <th class="px-6 py-4 text-right bg-green-50/30 text-green-800 whitespace-nowrap w-28">Sell (DA)</th>
                            <th class="px-6 py-4 text-center w-20">Qty</th>
                            <th class="px-6 py-4 text-right whitespace-nowrap">Profit (DA)</th>
                            <th class="px-6 py-4 text-right whitespace-nowrap">Margin</th>
                            <th class="px-6 py-4 w-12"></th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-[#e7e5e4]" id="tableBody">
                        <!-- Populated by JS -->
                    </tbody>
                    <tfoot class="bg-[#f5f5f4] font-bold text-[#1c1917] border-t-2 border-[#e7e5e4]">
                        <tr>
                            <td colspan="3" class="px-6 py-4 text-right text-[#a8a29e] uppercase text-xs tracking-wider">Totals:</td>
                            
                            <!-- Cost ($) Total -->
                            <td class="px-6 py-4 text-right font-mono text-[#57534e]" id="foot-cost-usd">0.00</td>
                            
                            <!-- Cost (DA) Total -->
                            <td class="px-6 py-4 text-right font-mono text-red-800 bg-red-50/50" id="foot-cost">0</td>
                            
                            <!-- Sell (DA) Total -->
                            <td class="px-6 py-4 text-right font-mono text-green-800 bg-green-50/50" id="foot-rev">0</td>
                            
                            <!-- Qty Total -->
                            <td class="px-6 py-4 text-center font-mono" id="foot-qty">0</td>
                            
                            <!-- Profit Total -->
                            <td class="px-6 py-4 text-right font-mono text-indigo-600 text-base" id="foot-profit">0</td>
                            
                            <!-- Margin Total (Avg) -->
                            <td class="px-6 py-4 text-right font-mono text-xs" id="foot-margin">0%</td>
                            
                            <td class="px-6 py-4"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </section>

    </main>

    <footer class="bg-white border-t border-[#e7e5e4] py-8 mt-auto">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-sm text-[#a8a29e]">&copy; 2025 Interactive Pricing Dashboard.</p>
        </div>
    </footer>

    <!-- JS Logic -->
    <script>
        // --- DATA MANAGEMENT (LocalStorage) ---
        const DB_KEY_DATA = 'smm_dashboard_data_v2';
        const DB_KEY_RATE = 'smm_dashboard_rate_v2';

        // Default Data
        const defaultData = [
            { id: 10145, platform: 'Instagram', service: '1k Followers (HQ)', buyUSD: 0.85, sellDA: 450, qty: 10 },
            { id: 10222, platform: 'Instagram', service: '1k Likes', buyUSD: 0.12, sellDA: 100, qty: 50 },
            { id: 20133, platform: 'TikTok', service: '1k Followers', buyUSD: 1.20, sellDA: 600, qty: 5 },
            { id: 20299, platform: 'TikTok', service: '1k Likes', buyUSD: 0.45, sellDA: 250, qty: 20 },
        ];

        // Load State
        let serviceData = JSON.parse(localStorage.getItem(DB_KEY_DATA)) || defaultData;
        let currentRate = parseInt(localStorage.getItem(DB_KEY_RATE)) || 255;
        
        let activeFilter = 'all';
        let arbChart = null;
        let distChart = null;

        // --- DOM ELEMENTS ---
        const slider = document.getElementById('rateSlider');
        const rateDisplay = document.getElementById('rateDisplay');
        const tableBody = document.getElementById('tableBody');
        const filterContainer = document.getElementById('filterContainer');
        const kpiRevenue = document.getElementById('kpi-revenue');
        const kpiProfit = document.getElementById('kpi-profit');
        const kpiMargin = document.getElementById('kpi-margin');

        // Footer Elements
        const footCostUSD = document.getElementById('foot-cost-usd');
        const footCost = document.getElementById('foot-cost');
        const footRev = document.getElementById('foot-rev');
        const footQty = document.getElementById('foot-qty');
        const footProfit = document.getElementById('foot-profit');
        const footMargin = document.getElementById('foot-margin');

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial inputs
            slider.value = currentRate;
            rateDisplay.textContent = currentRate.toFixed(1);

            initCharts();
            updateDashboard();
            updateFilterButtons();
            
            slider.addEventListener('input', (e) => {
                currentRate = parseInt(e.target.value);
                rateDisplay.textContent = currentRate.toFixed(1);
                // Save Rate Preference
                localStorage.setItem(DB_KEY_RATE, currentRate);
                updateDashboard();
            });
        });

        function resetData() {
            if(confirm("Reset all data to default examples? You will lose custom entries.")) {
                serviceData = JSON.parse(JSON.stringify(defaultData)); // Deep copy
                saveData();
                updateDashboard();
                updateFilterButtons();
            }
        }

        function saveData() {
            localStorage.setItem(DB_KEY_DATA, JSON.stringify(serviceData));
        }

        // --- MODAL FUNCTIONS ---
        function openAddModal() {
            document.getElementById('addModal').classList.remove('hidden');
            // Check if there is an existing max ID to suggest next one
            const maxId = serviceData.length > 0 ? Math.max(...serviceData.map(s => s.id)) : 0;
            document.getElementById('newId').value = maxId + 1;
            document.getElementById('newPlatform').focus();
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.add('hidden');
            // Clear inputs
            document.getElementById('newId').value = '';
            document.getElementById('newPlatform').value = '';
            document.getElementById('newService').value = '';
            document.getElementById('newCost').value = '';
            document.getElementById('newSell').value = '';
            document.getElementById('newQty').value = '1';
        }

        function saveNewService() {
            const rawId = document.getElementById('newId').value;
            const platform = document.getElementById('newPlatform').value.trim();
            const service = document.getElementById('newService').value.trim();
            const cost = parseFloat(document.getElementById('newCost').value);
            const sell = parseFloat(document.getElementById('newSell').value);
            const qty = parseInt(document.getElementById('newQty').value) || 1;

            if (!platform || !service || isNaN(cost) || isNaN(sell)) {
                alert("Please fill in all fields correctly.");
                return;
            }

            // ID Logic
            let newId;
            if (rawId) {
                newId = parseInt(rawId);
                // Check duplicate
                if (serviceData.some(s => s.id === newId)) {
                    alert("ID " + newId + " already exists. Please choose another ID.");
                    return;
                }
            } else {
                newId = serviceData.length > 0 ? Math.max(...serviceData.map(s => s.id)) + 1 : 1;
            }
            
            serviceData.push({
                id: newId,
                platform: platform,
                service: service,
                buyUSD: cost,
                sellDA: sell,
                qty: qty
            });

            saveData(); // Save to LocalStorage
            closeAddModal();
            updateFilterButtons(); 
            updateDashboard();
        }

        // --- CRUD OPERATIONS ---
        function updateValue(id, field, value) {
            const numVal = parseFloat(value);
            if (isNaN(numVal)) return;

            const index = serviceData.findIndex(item => item.id === id);
            if (index !== -1) {
                // If modifying ID, ensure no collision
                if (field === 'id' && numVal !== id) {
                    if (serviceData.some(s => s.id === numVal)) {
                        alert("ID already exists.");
                        // Revert visual change
                        updateDashboard();
                        return;
                    }
                }
                serviceData[index][field] = numVal;
                saveData(); // Save to LocalStorage
                updateDashboard(); 
            }
        }

        function deleteService(id) {
            if(confirm('Remove this service?')) {
                serviceData = serviceData.filter(item => item.id !== id);
                saveData(); // Save to LocalStorage
                updateDashboard();
                updateFilterButtons();
            }
        }

        // --- DASHBOARD LOGIC ---
        function updateDashboard() {
            // 1. Recalculate Data
            let totalRev = 0;
            let totalProfit = 0;
            let totalCost = 0;
            let totalQty = 0;
            let totalCostUSD = 0;
            
            const processedData = serviceData.map(item => {
                const qty = item.qty || 0;
                const costDA_Unit = item.buyUSD * currentRate;
                const costDA_Total = costDA_Unit * qty;
                
                const sellDA_Unit = item.sellDA;
                const sellDA_Total = sellDA_Unit * qty;
                
                const profitDA_Total = sellDA_Total - costDA_Total;
                
                // Margin calculation (on total revenue)
                const margin = sellDA_Total > 0 ? (profitDA_Total / sellDA_Total) * 100 : 0;
                
                return { 
                    ...item, 
                    costDA_Unit, 
                    costDA_Total, 
                    sellDA_Unit, 
                    sellDA_Total, 
                    profitDA_Total, 
                    margin 
                };
            });

            // 2. Render Table FIRST to filter data
            const visibleData = renderTable(processedData);

            // 3. Calculate Totals based on VISIBLE (Filtered) items
            visibleData.forEach(item => {
                totalRev += item.sellDA_Total;
                totalProfit += item.profitDA_Total;
                totalCost += item.costDA_Total;
                totalQty += item.qty;
                totalCostUSD += (item.buyUSD * item.qty);
            });

            // 4. Update KPIs (Global View or Filtered View - dashboard usually reflects table)
            kpiRevenue.textContent = totalRev.toLocaleString() + ' DA';
            kpiProfit.textContent = totalProfit.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0}) + ' DA';
            const globalMargin = totalRev > 0 ? (totalProfit / totalRev) * 100 : 0;
            kpiMargin.textContent = globalMargin.toFixed(1) + '%';
            kpiMargin.className = `text-3xl font-bold ${globalMargin >= 0 ? 'text-emerald-600' : 'text-red-600'}`;

            // 5. Update Footer (Now aligned column by column)
            footCostUSD.innerText = '$' + totalCostUSD.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            footCost.innerText = totalCost.toLocaleString(undefined, {maximumFractionDigits: 0});
            footRev.innerText = totalRev.toLocaleString(undefined, {maximumFractionDigits: 0});
            footQty.innerText = totalQty.toLocaleString();
            footProfit.innerText = totalProfit.toLocaleString(undefined, {maximumFractionDigits: 0});
            
            // Format Margin Footer
            footMargin.innerText = globalMargin.toFixed(1) + '%';
            footMargin.className = `px-6 py-4 text-right font-mono text-xs font-bold ${globalMargin >= 0 ? 'text-emerald-600' : 'text-red-600'}`;

            // 6. Update Charts
            updateCharts(visibleData);
        }

        function renderTable(data) {
            tableBody.innerHTML = '';
            const filtered = activeFilter === 'all' ? data : data.filter(d => d.platform === activeFilter);

            if (filtered.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" class="px-6 py-8 text-center text-[#a8a29e]">No services found. Add one to get started.</td></tr>';
                return [];
            }

            filtered.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-[#f5f5f4] transition group border-b border-[#f5f5f4] last:border-0';
                row.innerHTML = `
                    <td class="px-6 py-4 text-center font-mono text-[#a8a29e] text-xs">
                        <input type="number" value="${item.id}" 
                            onchange="updateValue(${item.id}, 'id', this.value)"
                            class="table-input text-center w-24 text-[#a8a29e]">
                    </td>
                    <td class="px-6 py-4 font-medium text-[#1c1917]">${item.platform}</td>
                    <td class="px-6 py-4 text-[#57534e]">${item.service}</td>
                    <td class="px-6 py-4 text-right font-mono text-[#a8a29e]">
                        <div class="flex items-center justify-end gap-1">
                            <span class="text-xs text-gray-400">$</span>
                            <input type="number" value="${item.buyUSD}" step="0.01" 
                                onchange="updateValue(${item.id}, 'buyUSD', this.value)"
                                class="table-input font-mono w-20">
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right font-mono font-medium text-red-700 bg-red-50/30">${item.costDA_Unit.toFixed(0)}</td>
                    <td class="px-6 py-4 text-right">
                         <div class="flex items-center justify-end gap-1 bg-green-50/30 rounded px-2">
                            <input type="number" value="${item.sellDA}" step="10" 
                                onchange="updateValue(${item.id}, 'sellDA', this.value)"
                                class="table-input font-mono font-medium text-green-700 bg-transparent w-20">
                            <span class="text-xs text-green-700 font-bold">DA</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <input type="number" value="${item.qty}" step="1" min="0"
                                onchange="updateValue(${item.id}, 'qty', this.value)"
                                class="table-input font-mono text-center w-16 bg-[#e5e7eb]/50 focus:bg-white border-b border-gray-300">
                    </td>
                    <td class="px-6 py-4 text-right font-mono font-bold ${item.profitDA_Total >= 0 ? 'text-[#1c1917]' : 'text-red-600'}">${item.profitDA_Total.toFixed(0)}</td>
                    <td class="px-6 py-4 text-right font-mono text-xs ${item.margin >= 0 ? 'text-emerald-600' : 'text-red-600'}">${item.margin.toFixed(1)}%</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="deleteService(${item.id})" class="text-[#d6d3d1] hover:text-red-500 transition opacity-0 group-hover:opacity-100 font-bold text-xl leading-none">&times;</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            return filtered;
        }

        function updateFilterButtons() {
            // Extract unique platforms from data
            const platforms = ['all', ...new Set(serviceData.map(item => item.platform))];
            
            filterContainer.innerHTML = '';
            platforms.forEach(p => {
                const btn = document.createElement('button');
                const isActive = activeFilter === p;
                btn.textContent = p === 'all' ? 'All' : p;
                btn.onclick = () => { activeFilter = p; updateFilterButtons(); updateDashboard(); };
                btn.className = `px-3 py-1.5 text-sm font-medium rounded-md transition capitalize ${
                    isActive 
                    ? 'bg-[#1c1917] text-white shadow-md' 
                    : 'bg-white border border-[#e7e5e4] text-[#57534e] hover:bg-[#f5f5f4]'
                }`;
                filterContainer.appendChild(btn);
            });
        }

        // --- CHART.JS CONFIG ---
        function initCharts() {
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.color = '#78716c';

            const ctxArb = document.getElementById('arbitrageChart').getContext('2d');
            arbChart = new Chart(ctxArb, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Total Cost (DA)', data: [], backgroundColor: '#e5e5e5', borderRadius: 4, barPercentage: 0.6 },
                        { label: 'Total Revenue (DA)', data: [], backgroundColor: '#6366f1', borderRadius: 4, barPercentage: 0.6 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toLocaleString() + " DA";
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: { position: 'top', align: 'end', labels: { boxWidth: 10, usePointStyle: true } } 
                    },
                    scales: { x: { grid: { display: false } }, y: { beginAtZero: true, border: { display: false }, grid: { borderDash: [4, 4], color: '#f5f5f4' } } }
                }
            });

            const ctxDist = document.getElementById('distributionChart').getContext('2d');
            distChart = new Chart(ctxDist, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: ['#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe', '#e0e7ff'], borderWidth: 0 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 10, usePointStyle: true } } },
                    cutout: '75%'
                }
            });
        }

        function updateCharts(data) {
            // 1. Bar Chart: Top 5 Profitable (TOTAL PROFIT)
            const topItems = [...data].sort((a, b) => b.profitDA_Total - a.profitDA_Total).slice(0, 6);
            arbChart.data.labels = topItems.map(d => d.service.length > 15 ? d.service.substring(0,15)+'...' : d.service);
            arbChart.data.datasets[0].data = topItems.map(d => d.costDA_Total);
            arbChart.data.datasets[1].data = topItems.map(d => d.sellDA_Total);
            arbChart.update();

            // 2. Doughnut Chart: Platform Mix
            const platforms = [...new Set(data.map(d => d.platform))];
            const counts = platforms.map(p => data.filter(d => d.platform === p).length);
            distChart.data.labels = platforms;
            distChart.data.datasets[0].data = counts;
            distChart.update();
        }
    </script>
</body>
</html>
