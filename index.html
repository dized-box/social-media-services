<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Pricing Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .chart-container { position: relative; width: 100%; height: 280px; }

        .custom-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }

        /* Unified Table Input Styling - COMPACT */
        .table-input {
            background: transparent; 
            border: 1px solid transparent; 
            border-radius: 3px; 
            padding: 2px 4px; 
            width: 100%; 
            transition: all 0.15s ease-in-out; 
            font-size: 0.85rem; 
            color: #334155;
            font-weight: 500;
        }
        .table-input:hover { background-color: #f8fafc; border-color: #e2e8f0; }
        .table-input:focus { 
            background-color: #ffffff; 
            border-color: #6366f1; 
            outline: none; 
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1); 
            color: #0f172a;
        }
        .table-input.num-input { text-align: right; font-family: 'Inter', monospace; }

        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .draggable-row.dragging { opacity: 0.6; background-color: #eff6ff; border: 2px dashed #6366f1; transform: scale(0.99); }
        .drag-handle { cursor: grab; touch-action: none; color: #cbd5e1; transition: color 0.2s; }
        .drag-handle:hover { color: #64748b; }
        .drag-handle:active { cursor: grabbing; }

        /* Compact Header */
        th { font-size: 0.7rem !important; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; font-weight: 700; }
    </style>
</head>
<body class="bg-[#f1f5f9] text-[#0f172a] antialiased min-h-screen flex flex-col overflow-hidden">

    <!-- AUTH SCREEN -->
    <div id="auth-container" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-slate-900 to-indigo-900">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden mx-4 p-10">
            <div class="text-center mb-8">
                <div class="mx-auto w-14 h-14 bg-indigo-100 rounded-full flex items-center justify-center mb-4 text-3xl">üîê</div>
                <h1 class="text-2xl font-bold text-slate-900">Store Manager</h1>
                <p class="text-slate-500 text-sm mt-1">Secure Business Dashboard</p>
            </div>
            <div id="auth-error" class="hidden bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4 text-center"></div>
            <div class="space-y-5">
                <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wider block mb-1">Email</label><input type="email" id="auth-email" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition"></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wider block mb-1">Password</label><input type="password" id="auth-password" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition"></div>
                <div class="pt-2 flex flex-col gap-3">
                    <button id="loginBtn" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg transition transform active:scale-95">Sign In</button>
                    <button id="registerBtn" class="w-full py-3 bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 rounded-xl font-bold transition">Create Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SIDEBAR & OVERLAY -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-slate-900/50 z-40 hidden backdrop-blur-sm transition-opacity"></div>
    <div id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-white border-r border-slate-200 z-50 transform -translate-x-full shadow-2xl flex flex-col">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><span>üìä</span> Dashboard</h2>
            <button id="closeSidebarBtn" class="text-slate-400 hover:text-red-500 text-2xl">&times;</button>
        </div>
        <nav class="flex-1 p-3 space-y-1 overflow-y-auto">
            <div class="px-3 pt-4 pb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">Catalog</div>
            <button onclick="switchView('smm')" id="nav-smm" class="w-full text-left px-3 py-2.5 rounded-lg font-medium transition flex items-center gap-3 bg-indigo-50 text-indigo-700">
                <span class="text-lg w-6 text-center">üì±</span> Social Media
            </button>
            <button onclick="switchView('games')" id="nav-games" class="w-full text-left px-3 py-2.5 rounded-lg font-medium text-slate-600 hover:bg-slate-50 transition flex items-center gap-3">
                <span class="text-lg w-6 text-center">üéÆ</span> Games Top-up
            </button>
            <button onclick="switchView('accounts')" id="nav-accounts" class="w-full text-left px-3 py-2.5 rounded-lg font-medium text-slate-600 hover:bg-slate-50 transition flex items-center gap-3">
                <span class="text-lg w-6 text-center">üîê</span> Accounts Shop
            </button>
            <button onclick="switchView('canva')" id="nav-canva" class="w-full text-left px-3 py-2.5 rounded-lg font-medium text-slate-600 hover:bg-slate-50 transition flex items-center gap-3">
                <span class="text-lg w-6 text-center">üé®</span> Canva Pro
            </button>
            
            <div class="px-3 pt-6 pb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">Business</div>
            <button onclick="switchView('sales')" id="nav-sales" class="w-full text-left px-3 py-2.5 rounded-lg font-medium text-slate-600 hover:bg-slate-50 transition flex items-center gap-3">
                <span class="text-lg w-6 text-center">üìà</span> Sales & Ledger
            </button>
        </nav>
        <div class="p-4 border-t border-slate-100 bg-slate-50">
            <button id="logoutBtn" class="w-full px-4 py-2 text-sm font-bold text-red-600 border border-red-200 bg-white rounded-lg hover:bg-red-50 transition">Sign Out</button>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="hidden flex flex-col h-screen w-full overflow-hidden">

        <!-- ADD SERVICE MODAL -->
        <div id="addModal" class="fixed inset-0 z-[100] hidden bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden border border-slate-200 flex flex-col max-h-[90vh]">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-lg text-slate-800" id="modalTitle">Add Item</h3>
                    <button id="closeModalBtn" class="text-slate-400 hover:text-red-500 text-2xl leading-none">&times;</button>
                </div>
                <div class="p-6 space-y-5 overflow-y-auto custom-scroll">
                    <!-- Dynamic Fields Container -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">ID</label><input type="number" id="newId" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:border-indigo-500"></div>
                        
                        <!-- Section Specific Inputs -->
                        <div class="col-span-1 smm-field accounts-field"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Platform</label><input type="text" id="newPlatform" placeholder="e.g. Netflix" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:border-indigo-500"></div>
                        <div class="col-span-1 game-field hidden"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Game Name</label><input type="text" id="newGameName" placeholder="e.g. Free Fire" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:border-indigo-500"></div>
                        <div class="col-span-1 canva-field hidden"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Customer Name</label><input type="text" id="newName" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:border-indigo-500"></div>
                    </div>

                    <!-- Category / Type Row -->
                    <div class="grid grid-cols-2 gap-4 smm-field accounts-field">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Category</label><input type="text" id="newCategory" list="catList" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:border-indigo-500"><datalist id="catList"><option value="Followers"><option value="Likes"><option value="Streaming"><option value="Gaming"></datalist></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Type (Tag)</label><input type="text" id="newType" placeholder="HQ, Private..." class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:border-indigo-500"></div>
                    </div>
                    
                    <!-- Games Specific -->
                    <div class="grid grid-cols-2 gap-4 game-field hidden">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Console</label><input type="text" id="newGameConsole" placeholder="Mobile, PC..." list="consoleList" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:border-indigo-500"><datalist id="consoleList"><option value="Mobile"><option value="PC"><option value="Xbox"></datalist></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Provider</label><input type="text" id="newProvider" placeholder="Supplier Name" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:border-indigo-500"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 game-field hidden">
                         <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Method</label><input type="text" id="newGameMethod" list="methodList" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:border-indigo-500"><datalist id="methodList"><option value="ID"><option value="Login"><option value="Code"></datalist></div>
                         <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Amount</label><input type="text" id="newAmount" placeholder="100 Gems" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:border-indigo-500"></div>
                    </div>

                    <!-- Canva Specific -->
                    <div class="canva-field hidden"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Customer Email</label><input type="email" id="newEmail" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:border-indigo-500"></div>
                    <div class="grid grid-cols-2 gap-4 canva-field hidden">
                         <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Start Date</label><input type="date" id="newStartDate" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:border-indigo-500"></div>
                         <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">End Date</label><input type="date" id="newEndDate" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:border-indigo-500"></div>
                    </div>

                    <!-- Item Name -->
                    <div class="smm-field accounts-field"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Item Name</label><input type="text" id="newService" placeholder="1k Followers..." class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:border-indigo-500"></div>

                    <!-- Financials -->
                    <div class="grid grid-cols-3 gap-4 bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <div class="smm-field game-field accounts-field"><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Cost ($)</label><input type="number" id="newCost" step="0.01" class="w-full p-2 border border-slate-200 rounded-md outline-none"></div>
                        <div class="canva-field hidden"><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Cost (DA)</label><input type="number" id="newCostDA" step="10" class="w-full p-2 border border-slate-200 rounded-md outline-none"></div>
                        <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Sell (DA)</label><input type="number" id="newSell" step="10" class="w-full p-2 border border-slate-200 rounded-md outline-none"></div>
                        <div class="smm-field accounts-field"><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Qty</label><input type="number" id="newQty" value="1" class="w-full p-2 border border-slate-200 rounded-md outline-none"></div>
                    </div>

                    <div class="smm-field game-field accounts-field"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Purchase Link</label><input type="url" id="newLink" placeholder="https://..." class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:border-indigo-500 text-blue-600"></div>
                </div>
                <div class="px-6 py-4 bg-slate-50 flex justify-end gap-3 border-t border-slate-100">
                    <button id="cancelModalBtn" class="px-5 py-2 text-sm font-bold text-slate-500 hover:bg-slate-200 rounded-lg transition">Cancel</button>
                    <button id="saveServiceBtn" class="px-5 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-md transition transform active:scale-95">Save Item</button>
                </div>
            </div>
        </div>

        <!-- RECORD SALE MODAL -->
        <div id="saleModal" class="fixed inset-0 z-[100] hidden bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden border border-slate-200 flex flex-col">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                    <h3 class="font-bold text-lg text-slate-800">Record Transaction</h3>
                    <button onclick="document.getElementById('saleModal').classList.add('hidden')" class="text-slate-400 hover:text-red-500 text-2xl leading-none">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Select Item</label>
                        <select id="saleServiceSelect" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none bg-slate-50 focus:bg-white transition text-sm">
                            <option value="">-- Choose from Catalog --</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Sell Price (DA)</label><input type="number" id="saleSellPrice" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none font-bold text-green-600"></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cost (DA)</label><input type="number" id="saleCostPrice" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none bg-slate-50 text-slate-500"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Quantity</label><input type="number" id="saleQty" value="1" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none text-center font-bold"></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label><input type="date" id="saleDate" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none"></div>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Notes / Customer</label><input type="text" id="saleNotes" placeholder="Optional notes..." class="w-full p-2.5 border border-slate-200 rounded-lg outline-none"></div>
                </div>
                <div class="px-6 py-4 bg-slate-50 flex justify-end gap-3 border-t border-slate-100">
                    <button onclick="document.getElementById('saleModal').classList.add('hidden')" class="px-4 py-2 text-sm font-bold text-slate-500 hover:bg-slate-200 rounded-lg transition">Cancel</button>
                    <button id="confirmSaleBtn" class="px-4 py-2 text-sm font-bold text-white bg-green-600 hover:bg-green-700 rounded-lg shadow-md transition transform active:scale-95">Confirm Sale</button>
                </div>
            </div>
        </div>

        <!-- APP HEADER -->
        <header class="bg-white border-b border-slate-200 flex-shrink-0 z-30 shadow-sm relative">
            <div class="max-w-[98%] mx-auto px-4 py-3 flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <button id="sidebarToggle" class="text-slate-400 hover:text-indigo-600 p-1"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
                    <div>
                        <h1 class="text-xl font-bold tracking-tight text-slate-800" id="pageTitle">Social Media Services</h1>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-slate-400 font-medium" id="userEmailDisplay">...</span>
                        </div>
                    </div>
                </div>
                <!-- Rate Control -->
                <div class="bg-slate-50 rounded-lg p-2 flex items-center gap-4 border border-slate-200 shadow-sm">
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">USD to DA</div>
                    <div class="flex items-center gap-2">
                        <input type="range" id="rateSlider" min="200" max="300" value="255" class="w-24 h-2 bg-slate-200 rounded-lg cursor-pointer accent-indigo-600">
                        <div class="bg-white px-2 py-1 rounded border border-slate-200 font-mono font-bold text-indigo-600 text-sm shadow-sm" id="rateDisplay">255.0</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- CONTENT AREA -->
        <main class="flex-1 overflow-y-auto custom-scroll w-full bg-[#f1f5f9]">
            <div class="max-w-[98%] mx-auto px-4 py-6 space-y-6">

                <!-- MAIN KPIS -->
                <section id="main-kpis" class="grid grid-cols-2 lg:grid-cols-5 gap-4">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 stat-card"><div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Total Cost ($)</div><div class="text-2xl font-bold text-slate-700 mt-1" id="kpi-cost-usd">$0.00</div></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 stat-card"><div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Total Cost (DA)</div><div class="text-2xl font-bold text-red-500 mt-1" id="kpi-cost-da">0</div></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 stat-card"><div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Stock Value (Sell)</div><div class="text-2xl font-bold text-slate-800 mt-1" id="kpi-revenue">0</div></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 stat-card"><div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Proj. Profit</div><div class="text-2xl font-bold text-indigo-600 mt-1" id="kpi-profit">0</div></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 stat-card"><div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Avg. Margin</div><div class="text-2xl font-bold text-emerald-500 mt-1" id="kpi-margin">0%</div></div>
                </section>

                <!-- SMM VIEW -->
                <div id="view-smm" class="space-y-6">
                    <div class="flex flex-col md:flex-row justify-between gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex flex-wrap gap-2 items-center">
                            <select id="platformFilter" class="bg-slate-50 text-sm font-semibold text-slate-600 rounded-lg px-3 py-2 outline-none border border-slate-200 focus:border-indigo-500"><option value="all">All Platforms</option></select>
                            <select id="categoryFilter" class="bg-slate-50 text-sm font-semibold text-slate-600 rounded-lg px-3 py-2 outline-none border border-slate-200 focus:border-indigo-500"><option value="all">All Categories</option></select>
                            <select id="typeFilter" class="bg-slate-50 text-sm font-semibold text-slate-600 rounded-lg px-3 py-2 outline-none border border-slate-200 focus:border-indigo-500"><option value="all">All Types</option></select>
                        </div>
                        <button onclick="window.openAddModal()" class="flex items-center gap-2 px-5 py-2 text-sm font-bold text-white bg-slate-900 hover:bg-slate-800 rounded-lg shadow-md transition transform active:scale-95"><span>+ Add Service</span></button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-5 rounded-xl border border-slate-200 shadow-sm h-80"><canvas id="smmChart"></canvas></div>
                        <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm h-80"><canvas id="smmDistChart"></canvas></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto custom-scroll">
                            <table class="w-full text-left text-sm" id="smmTable">
                                <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-[10px] tracking-wider border-b border-slate-200">
                                    <tr>
                                        <th class="w-8 px-2 py-3"></th>
                                        <th class="px-2 py-1 w-12 text-center">ID</th>
                                        <th class="px-2 py-1 min-w-[120px]">Platform</th><th class="px-2 py-1 min-w-[120px]">Category</th><th class="px-2 py-1 min-w-[100px]">Type</th><th class="px-2 py-1 min-w-[150px]">Service</th>
                                        <th class="px-2 py-1 text-right w-24">Cost $</th><th class="px-2 py-1 text-right w-20 bg-red-50/50 text-red-700">Cost DA</th><th class="px-2 py-1 text-right w-20 bg-blue-50/50 text-blue-700">Sell $</th><th class="px-2 py-1 text-right w-24 bg-green-50/50 text-green-700">Sell DA</th>
                                        <th class="px-2 py-1 text-center w-12">Qty</th><th class="px-2 py-1 text-right font-bold text-slate-700">Profit</th><th class="px-2 py-1 text-right">Margin</th><th class="px-2 py-1 text-right w-20">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100" id="smmTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- GAMES VIEW -->
                <div id="view-games" class="hidden space-y-6">
                    <div class="flex flex-col md:flex-row justify-between gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex flex-wrap gap-2 items-center">
                            <select id="gameNameFilter" class="bg-slate-50 text-sm font-semibold text-slate-600 rounded-lg px-3 py-2 outline-none border border-slate-200"><option value="all">All Games</option></select>
                            <select id="gameConsoleFilter" class="bg-slate-50 text-sm font-semibold text-slate-600 rounded-lg px-3 py-2 outline-none border border-slate-200"><option value="all">All Consoles</option></select>
                            <select id="gameProviderFilter" class="bg-slate-50 text-sm font-semibold text-slate-600 rounded-lg px-3 py-2 outline-none border border-slate-200"><option value="all">All Providers</option></select>
                            <select id="gameCategoryFilter" class="bg-slate-50 text-sm font-semibold text-slate-600 rounded-lg px-3 py-2 outline-none border border-slate-200"><option value="all">All Methods</option></select>
                        </div>
                        <button onclick="window.openAddModal()" class="flex items-center gap-2 px-5 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-md transition transform active:scale-95"><span>+ Add Game</span></button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto custom-scroll">
                            <table class="w-full text-left text-sm" id="gamesTable">
                                <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-[10px] tracking-wider border-b border-slate-200">
                                    <tr>
                                        <th class="w-8 px-2 py-3"></th>
                                        <th class="px-2 py-1 w-12 text-center">ID</th>
                                        <th class="px-2 py-1 min-w-[150px]">Game Name</th><th class="px-2 py-1 min-w-[80px]">Console</th><th class="px-2 py-1 min-w-[120px]">Provider</th><th class="px-2 py-1 min-w-[120px]">Category</th><th class="px-2 py-1 min-w-[120px]">Amount</th>
                                        <th class="px-2 py-1 text-right w-24">Cost $</th><th class="px-2 py-1 text-right w-20 bg-red-50/50 text-red-700">Cost DA</th><th class="px-2 py-1 text-right w-20 bg-blue-50/50 text-blue-700">Sell $</th><th class="px-2 py-1 text-right w-24 bg-green-50/50 text-green-700">Sell DA</th>
                                        <th class="px-2 py-1 text-right font-bold text-slate-700">Profit</th><th class="px-2 py-1 text-right">Margin</th><th class="px-2 py-1 text-right w-20">Act</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100" id="gamesTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ACCOUNTS VIEW -->
                <div id="view-accounts" class="hidden space-y-6">
                    <div class="flex flex-col md:flex-row justify-between gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex flex-wrap gap-2 items-center">
                            <select id="accPlatformFilter" class="bg-slate-50 text-sm font-semibold text-slate-600 rounded-lg px-3 py-2 outline-none border border-slate-200"><option value="all">All Platforms</option></select>
                            <select id="accCategoryFilter" class="bg-slate-50 text-sm font-semibold text-slate-600 rounded-lg px-3 py-2 outline-none border border-slate-200"><option value="all">All Categories</option></select>
                            <select id="accTypeFilter" class="bg-slate-50 text-sm font-semibold text-slate-600 rounded-lg px-3 py-2 outline-none border border-slate-200"><option value="all">All Types</option></select>
                        </div>
                        <button onclick="window.openAddModal()" class="flex items-center gap-2 px-5 py-2 text-sm font-bold text-white bg-teal-600 hover:bg-teal-700 rounded-lg shadow-md transition transform active:scale-95"><span>+ Add Account</span></button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto custom-scroll">
                            <table class="w-full text-left text-sm" id="accountsTable">
                                <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-[10px] tracking-wider border-b border-slate-200">
                                    <tr>
                                        <th class="w-8 px-2 py-3"></th>
                                        <th class="px-2 py-1 w-12 text-center">ID</th>
                                        <th class="px-2 py-1 min-w-[120px]">Platform</th><th class="px-2 py-1 min-w-[120px]">Category</th><th class="px-2 py-1 min-w-[100px]">Type</th><th class="px-2 py-1 min-w-[150px]">Item Name</th>
                                        <th class="px-2 py-1 text-right w-24">Cost $</th><th class="px-2 py-1 text-right w-20 bg-red-50/50 text-red-700">Cost DA</th><th class="px-2 py-1 text-right w-20 bg-blue-50/50 text-blue-700">Sell $</th><th class="px-2 py-1 text-right w-24 bg-green-50/50 text-green-700">Sell DA</th><th class="px-2 py-1 text-center w-12">Qty</th><th class="px-2 py-1 text-right font-bold text-slate-700">Profit</th><th class="px-2 py-1 text-right">Margin</th><th class="px-2 py-1 text-right w-20">Act</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100" id="accountsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- CANVA VIEW -->
                <div id="view-canva" class="hidden space-y-6">
                    <div class="flex justify-end bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <button onclick="window.openAddModal()" class="flex items-center gap-2 px-5 py-2 text-sm font-bold text-white bg-[#6366f1] hover:bg-[#4f46e5] rounded-lg shadow-md transition transform active:scale-95"><span>+ Add Subscription</span></button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto custom-scroll">
                            <table class="w-full text-left text-sm" id="canvaTable">
                                <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-[10px] tracking-wider border-b border-slate-200">
                                    <tr>
                                        <th class="px-2 py-1 w-12 text-center">ID</th><th class="px-2 py-1 min-w-[150px]">Customer</th><th class="px-2 py-1 min-w-[180px]">Email</th><th class="px-2 py-1 w-24">Start</th><th class="px-2 py-1 w-24">End</th>
                                        <th class="px-2 py-1 text-right w-24">Cost $</th><th class="px-2 py-1 text-right w-20 bg-red-50/50 text-red-700">Cost DA</th><th class="px-2 py-1 text-right w-20 bg-blue-50/50 text-blue-700">Sell $</th><th class="px-2 py-1 text-right w-24 bg-green-50/50 text-green-700">Sell DA</th>
                                        <th class="px-2 py-1 text-right font-bold text-slate-700">Profit</th><th class="px-2 py-1 text-right">Margin</th><th class="px-2 py-1 text-right w-16">Act</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100" id="canvaTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SALES VIEW -->
                <div id="view-sales" class="hidden space-y-6">
                    <div class="flex flex-col md:flex-row justify-between gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex flex-wrap gap-3 items-center">
                            <div class="relative">
                                <input type="text" id="salesSearch" placeholder="Search..." class="pl-8 pr-3 py-2 bg-slate-50 border border-slate-200 text-sm rounded-lg outline-none w-48 focus:bg-white focus:border-indigo-500 transition">
                                <span class="absolute left-2.5 top-2.5 text-slate-400 text-xs">üîç</span>
                            </div>
                            <select id="salesDateFilter" class="bg-slate-50 text-sm font-semibold text-slate-600 rounded-lg px-3 py-2 outline-none border border-slate-200"><option value="all">All Time</option><option value="today">Today</option><option value="month">This Month</option></select>
                            <div class="flex gap-1 bg-slate-100 p-1 rounded-lg border border-slate-200">
                                <button onclick="window.downloadPDF()" class="px-3 py-1 text-xs font-bold text-slate-600 hover:bg-white hover:shadow-sm rounded transition">PDF</button>
                                <button onclick="window.exportCSV()" class="px-3 py-1 text-xs font-bold text-slate-600 hover:bg-white hover:shadow-sm rounded transition">CSV</button>
                            </div>
                        </div>
                        <button onclick="window.openSaleModal()" class="flex items-center gap-2 px-5 py-2 text-sm font-bold text-white bg-green-600 hover:bg-green-700 rounded-lg shadow-md transition transform active:scale-95"><span>+ Record Sale</span></button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto custom-scroll">
                            <table class="w-full text-left text-sm" id="salesTable">
                                <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-[10px] tracking-wider border-b border-slate-200">
                                    <tr>
                                        <th class="px-2 py-1 w-24">Date</th>
                                        <th class="px-2 py-1 min-w-[150px]">Service / Item</th>
                                        <th class="px-2 py-1 w-24">Category</th>
                                        <th class="px-2 py-1 min-w-[150px] text-slate-400">Notes</th>
                                        <th class="px-2 py-1 w-12 text-center">Qty</th>
                                        <th class="px-2 py-1 text-right text-red-500">Cost</th>
                                        <th class="px-2 py-1 text-right text-blue-600">Rev</th>
                                        <th class="px-2 py-1 text-right font-bold text-green-700">Profit</th>
                                        <th class="px-2 py-1 text-right w-12"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100" id="salesTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCdB5SZ9Xi6MVZl-DsmTgWjJPK5EId-4F8", authDomain: "dized-box.firebaseapp.com", projectId: "dized-box", storageBucket: "dized-box.firebasestorage.app", messagingSenderId: "163199308320", appId: "1:163199308320:web:7e8217dabae7668d016245", measurementId: "G-Q9GFSXFZG8" };
        const appId = 'SMM_Pricing_Dashboard_App';
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

        // --- STATE ---
        let userId = null; 
        let currentRate = 255;
        let currentView = 'smm';
        let smmData=[], canvaData=[], gamesData=[], accountsData=[], salesData=[];
        
        let smmFilters = { platform: 'all', category: 'all', type: 'all' };
        let gamesFilters = { game: 'all', console: 'all', provider: 'all', category: 'all' };
        let accountsFilters = { platform: 'all', category: 'all', type: 'all' };
        let salesFilters = { date: 'all', search: '' };
        
        let smmChart = null; let smmDistChart = null;
        let dragSrcEl = null; let dragSrcIndex = -1;

        // --- DOM REFERENCES ---
        const nav = { 
            smm: document.getElementById('nav-smm'), 
            canva: document.getElementById('nav-canva'), 
            games: document.getElementById('nav-games'), 
            accounts: document.getElementById('nav-accounts'), 
            sales: document.getElementById('nav-sales') 
        };
        const views = { 
            smm: document.getElementById('view-smm'), 
            canva: document.getElementById('view-canva'), 
            games: document.getElementById('view-games'), 
            accounts: document.getElementById('view-accounts'), 
            sales: document.getElementById('view-sales') 
        };
        const pageTitle = document.getElementById('pageTitle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const saleServiceSelect = document.getElementById('saleServiceSelect');

        // --- AUTH ---
        window.handleLogin = async function() {
            const email = document.getElementById('auth-email').value; const pass = document.getElementById('auth-password').value; 
            try { await signInWithEmailAndPassword(auth, email, pass); } catch (error) { document.getElementById('auth-error').textContent = error.message; document.getElementById('auth-error').classList.remove('hidden'); }
        }
        window.handleRegister = async function() {
            const email = document.getElementById('auth-email').value; const pass = document.getElementById('auth-password').value; 
            try { await createUserWithEmailAndPassword(auth, email, pass); } catch (error) { document.getElementById('auth-error').textContent = error.message; document.getElementById('auth-error').classList.remove('hidden'); }
        }
        window.handleLogout = function() { signOut(auth); }

        onAuthStateChanged(auth, async (user) => {
            if (user) { 
                if (user.isAnonymous || !user.email) { await signOut(auth); return; } // Force email login
                userId = user.uid; 
                document.getElementById('auth-container').classList.add('hidden'); 
                document.getElementById('app-container').classList.remove('hidden');
                setupRealtimeListeners();
            } 
            else { 
                userId = null; 
                document.getElementById('auth-container').classList.remove('hidden'); 
                document.getElementById('app-container').classList.add('hidden'); 
                smmData=[]; canvaData=[]; gamesData=[]; accountsData=[]; salesData=[]; 
            }
        });

        // --- INIT & LISTENERS ---
        window.addEventListener('load', () => { initCharts(); setupEventListeners(); });

        function setupEventListeners() {
            document.getElementById('loginBtn').onclick = window.handleLogin;
            document.getElementById('registerBtn').onclick = window.handleRegister;
            document.getElementById('logoutBtn').onclick = window.handleLogout;
            
            document.getElementById('rateSlider').addEventListener('input', (e) => {
                const v = parseInt(e.target.value); document.getElementById('rateDisplay').textContent = v.toFixed(1); currentRate = v; updateDashboard(); updateCanvaDashboard(); updateGamesDashboard(); updateAccountsDashboard();
                if(userId) setDoc(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'global'), { rate: v }, { merge: true });
            });
            
            // SMM Filters
            document.getElementById('platformFilter').addEventListener('change', (e) => { smmFilters.platform = e.target.value; smmFilters.category='all'; updateSMMCategoryFilter(); updateDashboard(); });
            document.getElementById('categoryFilter').addEventListener('change', (e) => { smmFilters.category = e.target.value; updateSMMTypeFilter(); updateDashboard(); });
            document.getElementById('typeFilter').addEventListener('change', (e) => { smmFilters.type = e.target.value; updateDashboard(); });
            
            // Games Filters
            document.getElementById('gameNameFilter').addEventListener('change', (e) => { gamesFilters.game = e.target.value; gamesFilters.console='all'; gamesFilters.provider='all'; gamesFilters.category='all'; updateGamesConsoleFilter(); updateGamesDashboard(); });
            document.getElementById('gameConsoleFilter').addEventListener('change', (e) => { gamesFilters.console = e.target.value; gamesFilters.provider='all'; gamesFilters.category='all'; updateGamesProviderFilter(); updateGamesDashboard(); });
            document.getElementById('gameProviderFilter').addEventListener('change', (e) => { gamesFilters.provider = e.target.value; gamesFilters.category='all'; updateGamesCategoryFilter(); updateGamesDashboard(); });
            document.getElementById('gameCategoryFilter').addEventListener('change', (e) => { gamesFilters.category = e.target.value; updateGamesDashboard(); });

            // Accounts Filters
            document.getElementById('accPlatformFilter').addEventListener('change', (e) => { accountsFilters.platform = e.target.value; accountsFilters.category='all'; updateAccountsCategoryFilter(); updateAccountsDashboard(); });
            document.getElementById('accCategoryFilter').addEventListener('change', (e) => { accountsFilters.category = e.target.value; updateAccountsTypeFilter(); updateAccountsDashboard(); });
            document.getElementById('accTypeFilter').addEventListener('change', (e) => { accountsFilters.type = e.target.value; updateAccountsDashboard(); });
            
            // Sales Filters
            document.getElementById('salesDateFilter').addEventListener('change', (e) => { salesFilters.date = e.target.value; updateSalesDashboard(); });
            document.getElementById('salesSearch').addEventListener('input', (e) => { salesFilters.search = e.target.value.toLowerCase(); updateSalesDashboard(); });

            // Modal Controls
            document.getElementById('closeModalBtn').onclick = () => document.getElementById('addModal').classList.add('hidden');
            document.getElementById('cancelModalBtn').onclick = () => document.getElementById('addModal').classList.add('hidden');
            document.getElementById('saveServiceBtn').onclick = window.saveNewService;
            
            // Sale Modal Interaction
            if (saleServiceSelect) {
                saleServiceSelect.addEventListener('change', (e) => {
                    if(!e.target.value) return;
                    const [source, id] = e.target.value.split(':');
                    let item;
                    if(source==='smm') item = smmData.find(i=>i.docId===id);
                    else if(source==='games') item = gamesData.find(i=>i.docId===id);
                    else if(source==='accounts') item = accountsData.find(i=>i.docId===id);
                    
                    if(item) {
                        const costDA = item.buyDA || (item.buyUSD * currentRate);
                        document.getElementById('saleSellPrice').value = item.sellDA;
                        document.getElementById('saleCostPrice').value = costDA.toFixed(0);
                    }
                });
            }
            document.getElementById('confirmSaleBtn').onclick = window.saveSaleRecord;

            document.getElementById('sidebarToggle').onclick = () => toggleSidebar(true);
            document.getElementById('closeSidebarBtn').onclick = () => toggleSidebar(false);
            document.getElementById('sidebar-overlay').onclick = () => toggleSidebar(false);
        }

        // --- GLOBAL EXPORTS ---
        window.openAddModal = () => {
            document.getElementById('addModal').classList.remove('hidden');
            let list = getGlobalData();
            const maxId = list.length > 0 ? Math.max(...list.map(i => i.customId || 0)) : 100;
            document.getElementById('newId').value = maxId + 1;
            const smmFields = document.querySelectorAll('.smm-field'); 
            const canvaFields = document.querySelectorAll('.canva-field');
            const gameFields = document.querySelectorAll('.game-field');
            const accountsFields = document.querySelectorAll('.accounts-field');

            document.querySelectorAll('.smm-field, .canva-field, .game-field').forEach(el => el.classList.add('hidden'));

            if(currentView === 'smm') {
                document.getElementById('modalTitle').textContent = "Add Social Media Service";
                smmFields.forEach(el => el.classList.remove('hidden'));
            } else if (currentView === 'canva') {
                document.getElementById('modalTitle').textContent = "Add Canva Subscription";
                canvaFields.forEach(el => el.classList.remove('hidden'));
            } else if (currentView === 'games') {
                document.getElementById('modalTitle').textContent = "Add Game Top-up";
                gameFields.forEach(el => el.classList.remove('hidden'));
            } else if (currentView === 'accounts') {
                document.getElementById('modalTitle').textContent = "Add Account Product";
                accountsFields.forEach(el => el.classList.remove('hidden'));
            }
        };

        window.openSaleModal = () => {
            document.getElementById('saleModal').classList.remove('hidden');
            document.getElementById('saleDate').valueAsDate = new Date();
            const saleServiceSelect = document.getElementById('saleServiceSelect');
            // Populate select
            saleServiceSelect.innerHTML = '<option value="">-- Choose from Catalog --</option>';
            
            // Group Options
            const addGroup = (label, data, source) => {
                if(data.length === 0) return;
                const group = document.createElement('optgroup');
                group.label = label;
                data.forEach(item => {
                    const name = item.service || item.game || item.platform; // Dynamic name logic
                    const opt = document.createElement('option');
                    opt.value = `${source}:${item.docId}`;
                    opt.textContent = name + (item.category ? ` - ${item.category}` : '');
                    group.appendChild(opt);
                });
                saleServiceSelect.appendChild(group);
            };

            addGroup("Social Media", smmData, "smm");
            addGroup("Games", gamesData, "games");
            addGroup("Accounts", accountsData, "accounts");
        };

        window.saveSaleRecord = async () => {
            const selectVal = document.getElementById('saleServiceSelect').value;
            if(!selectVal) { alert("Please select a service"); return; }
            
            const [source, id] = selectVal.split(':');
            let itemName = "", category = "";
            
            // Find item to get name ref
            if(source==='smm') { const i = smmData.find(x=>x.docId===id); itemName = i.service; category = i.platform; }
            else if(source==='games') { const i = gamesData.find(x=>x.docId===id); itemName = i.game + " " + i.amount; category = "Games"; }
            else { const i = accountsData.find(x=>x.docId===id); itemName = i.service; category = i.platform; }

            const sell = parseFloat(document.getElementById('saleSellPrice').value)||0;
            const cost = parseFloat(document.getElementById('saleCostPrice').value)||0;
            const qty = parseInt(document.getElementById('saleQty').value)||1;
            const date = document.getElementById('saleDate').value;
            const notes = document.getElementById('saleNotes').value.trim();

            try {
                // Workers save sales to Admin's record
                await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'sales_records'), {
                    service: itemName, category, sell, cost, qty, date, notes,
                    profit: (sell - cost) * qty, timestamp: Date.now()
                });
                document.getElementById('saleModal').classList.add('hidden');
                document.getElementById('saleNotes').value = '';
            } catch(e) { console.error(e); alert("Failed to record sale"); }
        };
        
        window.deleteSale = async (id) => {
            if(confirm("Delete this sale record?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'sales_records', id));
            }
        };

        window.downloadPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.text("Sales Report", 14, 20);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);

            // Filtered data for PDF matches view
            const visibleSales = getVisibleSales();
            
            const tableData = visibleSales.map(row => [
                row.date,
                row.service,
                row.category,
                row.qty,
                row.sell.toFixed(0),
                row.profit.toFixed(0)
            ]);

            doc.autoTable({
                head: [['Date', 'Service', 'Category', 'Qty', 'Rev (DA)', 'Profit (DA)']],
                body: tableData,
                startY: 40,
            });

            doc.save('sales_report.pdf');
        };
        
        window.exportCSV = () => {
            const visibleSales = getVisibleSales();
            let csvContent = "data:text/csv;charset=utf-8,Date,Service,Category,Notes,Quantity,Cost (DA),Sell (DA),Profit (DA)\n";
            visibleSales.forEach(row => { const note = row.notes ? row.notes.replace(/,/g, " ") : ""; csvContent += `${row.date},${row.service},${row.category},${note},${row.qty},${row.cost},${row.sell},${row.profit}\n`; });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "sales_export.csv");
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        window.switchView = (view) => {
            currentView = view; toggleSidebar(false);
            
            // Hide all views first
            Object.values(views).forEach(v => v.classList.add('hidden'));
            
            // Reset nav styles
            Object.values(nav).forEach(n => {
                n.classList.remove('bg-indigo-50', 'text-indigo-700');
                n.classList.add('text-slate-600');
            });

            // Activate specific view and nav
            if(views[view]) {
                views[view].classList.remove('hidden');
                document.getElementById(`nav-${view}`).classList.add('bg-indigo-50', 'text-indigo-700');
                document.getElementById(`nav-${view}`).classList.remove('text-slate-600');
            }

            if(view === 'smm') {
                pageTitle.textContent = "Social Media Services";
                updateDashboard();
            } else if(view === 'canva') {
                pageTitle.textContent = "Canva Pro Invitations";
                updateCanvaDashboard();
            } else if (view === 'games') {
                pageTitle.textContent = "Games Top-up";
                updateGamesDashboard();
            } else if (view === 'accounts') {
                pageTitle.textContent = "Accounts Shop";
                updateAccountsDashboard();
            } else if (view === 'sales') {
                pageTitle.textContent = "Sales & Ledger";
                updateSalesDashboard();
            }
        };

        window.saveNewService = async () => {
            if(!userId) return;
            const common = { customId: parseInt(document.getElementById('newId').value) || 0, createdAt: Date.now() };
            try {
                if(currentView === 'smm' || currentView === 'accounts') {
                    const colName = currentView === 'smm' ? 'services' : 'accounts_services';
                    await addDoc(collection(db, 'artifacts', appId, 'users', userId, colName), { ...common,
                        platform: document.getElementById('newPlatform').value, category: document.getElementById('newCategory').value,
                        type: document.getElementById('newType').value, service: document.getElementById('newService').value,
                        buyUSD: parseFloat(document.getElementById('newCost').value) || 0,
                        sellDA: parseFloat(document.getElementById('newSell').value) || 0,
                        qty: parseInt(document.getElementById('newQty').value)||1, link: document.getElementById('newLink').value, sortOrder: getGlobalData().length
                    });
                } else if(currentView === 'canva') {
                    await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'canva_services'), { ...common,
                        name: document.getElementById('newName').value, email: document.getElementById('newEmail').value,
                        startDate: document.getElementById('newStartDate').value, endDate: document.getElementById('newEndDate').value,
                        buyDA: parseFloat(document.getElementById('newCostDA').value) || 0,
                        sellDA: parseFloat(document.getElementById('newSell').value) || 0,
                        sortOrder: canvaData.length
                    });
                } else if (currentView === 'games') {
                    await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'games_services'), { ...common,
                        game: document.getElementById('newGameName').value, console: document.getElementById('newGameConsole').value,
                        provider: document.getElementById('newProvider').value, category: document.getElementById('newGameMethod').value,
                        amount: document.getElementById('newAmount').value,
                        buyUSD: parseFloat(document.getElementById('newCost').value) || 0,
                        sellDA: parseFloat(document.getElementById('newSell').value) || 0,
                        link: document.getElementById('newLink').value, sortOrder: gamesData.length
                    });
                }
                document.getElementById('addModal').classList.add('hidden');
            } catch(e) { console.error(e); alert("Save failed"); }
        };

        // --- DATA & UI UPDATES ---
        function setupRealtimeListeners() {
            if(!userId) return;

            // Settings
            const settingsDoc = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'global');
            onSnapshot(settingsDoc, (s) => { if(s.exists()) { currentRate = s.data().rate || 255; document.getElementById('rateSlider').value = currentRate; document.getElementById('rateDisplay').textContent = currentRate.toFixed(1); updateDashboard(); updateCanvaDashboard(); updateGamesDashboard(); updateAccountsDashboard(); } else setDoc(settingsDoc, { rate: 255 }, { merge: true }); });
            
            const sortFn = (a, b) => (a.sortOrder ?? a.createdAt ?? 0) - (b.sortOrder ?? b.createdAt ?? 0);
            
            // Listeners for Shared Data
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, `services`), (s) => { smmData = []; s.forEach(d => smmData.push({...d.data(), docId: d.id})); smmData.sort(sortFn); updateSMMFilters(); updateDashboard(); });
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, `canva_services`), (s) => { canvaData = []; s.forEach(d => canvaData.push({...d.data(), docId: d.id})); canvaData.sort((a, b) => new Date(b.endDate || 0) - new Date(a.endDate || 0)); updateCanvaDashboard(); });
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, `games_services`), (s) => { gamesData = []; s.forEach(d => gamesData.push({...d.data(), docId: d.id})); gamesData.sort(sortFn); updateGamesFilters(); updateGamesDashboard(); });
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, `accounts_services`), (s) => { accountsData = []; s.forEach(d => accountsData.push({...d.data(), docId: d.id})); accountsData.sort(sortFn); updateAccountsFilters(); updateAccountsDashboard(); });
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, `sales_records`), (s) => { salesData = []; s.forEach(d => salesData.push({...d.data(), docId: d.id})); salesData.sort((a, b) => b.timestamp - a.timestamp); updateSalesDashboard(); });
        }

        // --- SMM LOGIC ---
        function updateSMMFilters() {
            const plats = [...new Set(smmData.map(i => i.platform || "Uncat"))].sort();
            const pf = document.getElementById('platformFilter');
            pf.innerHTML = '<option value="all">All Platforms</option>' + plats.map(p => `<option value="${p}">${p}</option>`).join('');
            if(plats.includes(smmFilters.platform)) pf.value = smmFilters.platform;
            updateSMMCategoryFilter();
        }
        function updateSMMCategoryFilter() {
            const plat = document.getElementById('platformFilter').value;
            let cats = plat === 'all' ? [...new Set(smmData.map(i => i.category || "Gen"))] : [...new Set(smmData.filter(i => i.platform === plat).map(i => i.category || "Gen"))];
            const cf = document.getElementById('categoryFilter');
            cf.innerHTML = '<option value="all">All Categories</option>' + cats.sort().map(c => `<option value="${c}">${c}</option>`).join('');
            if(cats.includes(smmFilters.category)) cf.value = smmFilters.category;
            updateSMMTypeFilter();
        }
        function updateSMMTypeFilter() {
            const plat = document.getElementById('platformFilter').value; const cat = document.getElementById('categoryFilter').value;
            let d = smmData; if(plat !== 'all') d = d.filter(i => i.platform === plat); if(cat !== 'all') d = d.filter(i => (i.category||"Gen") === cat);
            const types = [...new Set(d.map(i => i.type || ""))].filter(t => t !== "").sort();
            const tf = document.getElementById('typeFilter');
            tf.innerHTML = '<option value="all">All Types</option>' + types.map(t => `<option value="${t}">${t}</option>`).join('');
            if(types.includes(smmFilters.type)) tf.value = smmFilters.type;
        }

        function updateGamesFilters() {
            const games = [...new Set(gamesData.map(i => i.game || "Unk"))].sort();
            const gf = document.getElementById('gameNameFilter');
            gf.innerHTML = '<option value="all">All Games</option>' + games.map(g => `<option value="${g}">${g}</option>`).join('');
            if(games.includes(gamesFilters.game)) gf.value = gamesFilters.game;
            updateGamesConsoleFilter();
        }
        function updateGamesConsoleFilter() {
            const game = document.getElementById('gameNameFilter').value;
            let d = gamesData; if(game !== 'all') d = d.filter(i => (i.game||"Unk") === game);
            const cons = [...new Set(d.map(i => i.console || "PC"))].sort();
            const gcf = document.getElementById('gameConsoleFilter');
            gcf.innerHTML = '<option value="all">All Consoles</option>' + cons.map(c => `<option value="${c}">${c}</option>`).join('');
            if(cons.includes(gamesFilters.console)) gcf.value = gamesFilters.console; else { gcf.value = 'all'; gamesFilters.console = 'all'; }
            updateGamesProviderFilter();
        }
        function updateGamesProviderFilter() {
            const game = document.getElementById('gameNameFilter').value; const consoleVal = document.getElementById('gameConsoleFilter').value;
            let d = gamesData; if(game !== 'all') d = d.filter(i => (i.game||"Unk") === game); if(consoleVal !== 'all') d = d.filter(i => (i.console||"PC") === consoleVal);
            const provs = [...new Set(d.map(i => i.provider || "Unk"))].sort();
            const pf = document.getElementById('gameProviderFilter');
            pf.innerHTML = '<option value="all">All Providers</option>' + provs.map(p => `<option value="${p}">${p}</option>`).join('');
            if(provs.includes(gamesFilters.provider)) pf.value = gamesFilters.provider; else { pf.value = 'all'; gamesFilters.provider = 'all'; }
            updateGamesCategoryFilter();
        }
        function updateGamesCategoryFilter() {
            const game = document.getElementById('gameNameFilter').value; const consoleVal = document.getElementById('gameConsoleFilter').value; const prov = document.getElementById('gameProviderFilter').value;
            let d = gamesData; if(game !== 'all') d = d.filter(i => (i.game||"Unk") === game); if(consoleVal !== 'all') d = d.filter(i => (i.console||"PC") === consoleVal); if(prov !== 'all') d = d.filter(i => i.provider === prov);
            const cats = [...new Set(d.map(i => i.category || "General"))].sort();
            const gcf = document.getElementById('gameCategoryFilter');
            gcf.innerHTML = '<option value="all">All Methods</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
            if(cats.includes(gamesFilters.category)) gcf.value = gamesFilters.category; else { gcf.value = 'all'; gamesFilters.category = 'all'; }
        }

        function updateAccountsFilters() {
            const plats = [...new Set(accountsData.map(i => i.platform || "Uncat"))].sort();
            const pf = document.getElementById('accPlatformFilter');
            pf.innerHTML = '<option value="all">All Platforms</option>' + plats.map(p => `<option value="${p}">${p}</option>`).join('');
            if(plats.includes(accountsFilters.platform)) pf.value = accountsFilters.platform;
            updateAccountsCategoryFilter();
        }
        function updateAccountsCategoryFilter() {
            const plat = document.getElementById('accPlatformFilter').value;
            let cats = plat === 'all' ? [...new Set(accountsData.map(i => i.category || "Gen"))] : [...new Set(accountsData.filter(i => i.platform === plat).map(i => i.category || "Gen"))];
            const cf = document.getElementById('accCategoryFilter');
            cf.innerHTML = '<option value="all">All Categories</option>' + cats.sort().map(c => `<option value="${c}">${c}</option>`).join('');
            if(cats.includes(accountsFilters.category)) cf.value = accountsFilters.category;
            updateAccountsTypeFilter();
        }
        function updateAccountsTypeFilter() {
            const plat = document.getElementById('accPlatformFilter').value; const cat = document.getElementById('accCategoryFilter').value;
            let d = accountsData; if(plat !== 'all') d = d.filter(i => i.platform === plat); if(cat !== 'all') d = d.filter(i => (i.category||"Gen") === cat);
            const types = [...new Set(d.map(i => i.type || ""))].filter(t => t !== "").sort();
            const tf = document.getElementById('accTypeFilter');
            tf.innerHTML = '<option value="all">All Types</option>' + types.map(t => `<option value="${t}">${t}</option>`).join('');
            if(types.includes(accountsFilters.type)) tf.value = accountsFilters.type;
        }

        // --- DASHBOARDS ---
        function updateDashboard() {
            if(currentView !== 'smm') return;
            const visible = smmData.filter(i => (smmFilters.platform==='all'||i.platform===smmFilters.platform) && (smmFilters.category==='all'||(i.category||"Gen")===smmFilters.category) && (smmFilters.type==='all'||(i.type||"")===smmFilters.type));
            renderStandardTable(visible, 'smmTableBody');
        }

        function updateAccountsDashboard() {
            if(currentView !== 'accounts') return;
            const visible = accountsData.filter(i => (accountsFilters.platform==='all'||i.platform===accountsFilters.platform) && (accountsFilters.category==='all'||(i.category||"Gen")===accountsFilters.category) && (accountsFilters.type==='all'||(i.type||"")===accountsFilters.type));
            renderStandardTable(visible, 'accountsTableBody');
        }
        
        function updateSalesDashboard() {
            if(currentView !== 'sales') return;
            const visible = getVisibleSales();
            const tbody = document.getElementById('salesTableBody'); tbody.innerHTML = '';
            
            if(visible.length === 0) tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-slate-400">No transactions.</td></tr>';
            
            let tCostDA = 0;
            let tRev = 0;
            let tProfit = 0;

            visible.forEach(item => {
                const q = item.qty || 1;
                tCostDA += (item.cost * q);
                tRev += (item.sell * q);
                tProfit += ((item.sell - item.cost) * q);

                const tr = document.createElement('tr'); tr.className = "hover:bg-slate-50 border-b border-slate-100";
                tr.innerHTML = `
                    <td class="px-2 py-1 text-slate-600 font-mono text-xs">${item.date}</td>
                    <td class="px-2 py-1 font-medium text-slate-800 text-xs">${item.service}</td>
                    <td class="px-2 py-1 text-slate-500 text-xs">${item.category || '-'}</td>
                    <td class="px-2 py-1 text-slate-400 italic text-xs max-w-[150px] truncate" title="${item.notes||''}">${item.notes || '-'}</td>
                    <td class="px-2 py-1 text-center text-slate-700 text-xs">${item.qty}</td>
                    <td class="px-2 py-1 text-right text-red-500 font-mono text-xs">${item.cost.toFixed(0)}</td>
                    <td class="px-2 py-1 text-right text-slate-700 font-bold font-mono text-xs">${item.sell.toFixed(0)}</td>
                    <td class="px-2 py-1 text-right font-bold text-green-600 font-mono text-xs">${item.profit.toFixed(0)}</td>
                    <td class="px-2 py-1 text-right"><button onclick="window.deleteSale('${item.docId}')" class="text-slate-300 hover:text-red-500 text-xs">&times;</button></td>
                `;
                tbody.appendChild(tr);
            });
            
            const tCostUSD = currentRate > 0 ? tCostDA / currentRate : 0;
            updateKPIs(tCostUSD, tCostDA, tRev, tProfit);
        }

        function getVisibleSales() {
            const now = new Date();
            const filter = salesFilters.date;
            
            return salesData.filter(item => {
                const itemDate = new Date(item.date);
                if (filter === 'today') {
                    return itemDate.toDateString() === now.toDateString();
                } else if (filter === 'month') {
                    return itemDate.getMonth() === now.getMonth() && itemDate.getFullYear() === now.getFullYear();
                }
                return true;
            });
        }

        function renderStandardTable(data, bodyId) {
            let tCostUSD=0, tCostDA=0, tRev=0, tProfit=0;
            const tbody = document.getElementById(bodyId); tbody.innerHTML = '';
            if(data.length === 0) tbody.innerHTML = '<tr><td colspan="14" class="text-center py-8 text-slate-400">No items.</td></tr>';
            data.forEach((item, idx) => {
                const qty = item.qty||1; const costDA = item.buyUSD*currentRate; const profit = (item.sellDA - costDA) * qty;
                tCostUSD += item.buyUSD*qty; tCostDA += costDA*qty; tRev += item.sellDA*qty; tProfit += profit;
                const tr = document.createElement('tr'); tr.className = "hover:bg-slate-50 border-b border-slate-100 last:border-0 draggable-row group";
                
                const fnBase = currentView === 'smm' ? 'updSMM' : 'updAccount';
                const delFn = currentView === 'smm' ? 'delSMM' : 'delAccount';
                const dupFn = currentView === 'smm' ? 'dupSMM' : 'dupAccount';

                let btns = `<button onclick="window.${dupFn}('${item.docId}')" class="text-indigo-400 hover:text-indigo-600 p-1 mr-1 transition" title="Duplicate">‚ùê</button><button onclick="window.${delFn}('${item.docId}')" class="text-slate-400 hover:text-red-500 p-1 transition" title="Delete">&times;</button>`;
                if(item.link) btns = `<a href="${item.link}" target="_blank" class="text-blue-500 hover:text-blue-700 p-1 mr-1 transition" title="Link">‚Üó</a>` + btns;

                tr.innerHTML = `
                    <td class="px-2 py-1 text-center drag-handle text-slate-300 hover:text-slate-600"><span class="text-lg">‚â°</span></td>
                    <td class="px-2 py-1"><input class="table-input num-input text-xs text-slate-400 w-12" value="${item.customId||0}" onchange="${fnBase}('${item.docId}','customId',this.value)"></td>
                    <td class="px-2 py-1"><input class="table-input font-medium w-24" value="${item.platform}" onchange="${fnBase}('${item.docId}','platform',this.value)"></td>
                    <td class="px-2 py-1"><input class="table-input text-slate-500 text-xs w-24" value="${item.category||''}" onchange="${fnBase}('${item.docId}','category',this.value)"></td>
                    <td class="px-2 py-1"><input class="table-input text-xs text-slate-400 w-20" value="${item.type||''}" onchange="${fnBase}('${item.docId}','type',this.value)"></td>
                    <td class="px-2 py-1"><input class="table-input w-full" value="${item.service}" onchange="${fnBase}('${item.docId}','service',this.value)"></td>
                    <td class="px-2 py-1 financial-col"><input class="table-input num-input w-20" value="${item.buyUSD}" onchange="${fnBase}('${item.docId}','buyUSD',this.value)"></td>
                    <td class="px-2 py-1 text-right font-mono text-red-600 bg-red-50/50 rounded font-medium text-xs w-20">${costDA.toFixed(0)}</td>
                    <td class="px-2 py-1 text-right font-mono text-blue-600 bg-blue-50/50 rounded font-medium text-xs w-20">${(currentRate>0?item.sellDA/currentRate:0).toFixed(2)}</td>
                    <td class="px-2 py-1"><input class="table-input num-input font-bold text-green-700 w-20" value="${item.sellDA}" onchange="${fnBase}('${item.docId}','sellDA',this.value)"></td>
                    <td class="px-2 py-1"><input class="table-input num-input w-12" value="${qty}" onchange="${fnBase}('${item.docId}','qty',this.value)"></td>
                    <td class="px-2 py-1 text-right font-bold text-slate-700 text-xs">${profit.toFixed(0)}</td>
                    <td class="px-2 py-1 text-right text-xs text-slate-500">${(item.sellDA>0?(profit/(item.sellDA*qty)*100):0).toFixed(0)}%</td>
                    <td class="px-2 py-1 text-right whitespace-nowrap">${btns}</td>`;
                
                let allow = false;
                if(currentView==='smm' && smmFilters.platform==='all' && smmFilters.category==='all') allow=true;
                if(currentView==='accounts' && accountsFilters.platform==='all' && accountsFilters.category==='all') allow=true;

                if(allow) addDragEvents(tr, idx); else tr.querySelector('.drag-handle').classList.add('opacity-0','pointer-events-none');
                tbody.appendChild(tr);
            });
            updateKPIs(tCostUSD, tCostDA, tRev, tProfit); 
            if(currentView==='smm') updateCharts(data);
        }

        function updateGamesDashboard() {
            if(currentView !== 'games') return;
            const visible = getVisibleData();
            let tCostUSD=0, tCostDA=0, tRev=0, tProfit=0;
            const tbody = document.getElementById('gamesTableBody'); tbody.innerHTML = '';
            if(visible.length === 0) tbody.innerHTML = '<tr><td colspan="14" class="text-center py-8 text-slate-400">No games found.</td></tr>';
            visible.forEach((item, idx) => {
                const costDA = item.buyUSD * currentRate; const profit = item.sellDA - costDA;
                tCostUSD += item.buyUSD; tCostDA += costDA; tRev += item.sellDA; tProfit += profit;
                let btns = `<button onclick="window.delGame('${item.docId}')" class="text-red-500 hover:bg-red-50 p-1 rounded transition">&times;</button>`;
                if(item.link) btns = `<a href="${item.link}" target="_blank" class="text-blue-500 hover:bg-blue-50 p-1 mr-1 transition">‚Üó</a>` + btns;
                const tr = document.createElement('tr'); tr.className = "hover:bg-slate-50 border-b border-slate-100 last:border-0 draggable-row group";
                tr.innerHTML = `
                    <td class="px-2 py-1 text-center drag-handle text-slate-300 hover:text-slate-600"><span class="text-xl">‚â°</span></td>
                    <td class="px-2 py-1"><input class="table-input num-input text-xs text-slate-400 w-12" value="${item.customId||0}" onchange="updGame('${item.docId}','customId',this.value)"></td>
                    <td class="px-2 py-1"><input class="table-input w-32 font-medium" value="${item.game}" onchange="updGame('${item.docId}','game',this.value)"></td>
                    <td class="px-2 py-1"><input class="table-input text-xs text-slate-600 w-20" value="${item.console||''}" onchange="updGame('${item.docId}','console',this.value)"></td>
                    <td class="px-2 py-1"><input class="table-input text-xs text-slate-600 w-24" value="${item.provider}" onchange="updGame('${item.docId}','provider',this.value)"></td>
                    <td class="px-2 py-1"><input class="table-input text-slate-500 text-xs w-24" value="${item.category||''}" onchange="updGame('${item.docId}','category',this.value)"></td>
                    <td class="px-2 py-1"><input class="table-input text-slate-500 text-xs w-24" value="${item.amount}" onchange="updGame('${item.docId}','amount',this.value)"></td>
                    <td class="px-2 py-1 financial-col"><input class="table-input num-input w-20" value="${item.buyUSD}" onchange="updGame('${item.docId}','buyUSD',this.value)"></td>
                    <td class="px-2 py-1 text-right font-mono text-red-600 bg-red-50/50 rounded font-medium text-xs w-20">${costDA.toFixed(0)}</td>
                    <td class="px-2 py-1 text-right font-mono text-blue-600 bg-blue-50/50 rounded font-medium text-xs w-20">${(currentRate>0?item.sellDA/currentRate:0).toFixed(2)}</td>
                    <td class="px-2 py-1"><input class="table-input num-input font-bold text-green-700 w-20" value="${item.sellDA}" onchange="updGame('${item.docId}','sellDA',this.value)"></td>
                    <td class="px-2 py-1 text-right font-bold text-slate-700 text-xs">${profit.toFixed(0)}</td>
                    <td class="px-2 py-1 text-right text-xs text-slate-500">${(item.sellDA>0?(profit/item.sellDA*100):0).toFixed(0)}%</td>
                    <td class="px-2 py-1 text-right whitespace-nowrap">${btns}</td>`;
                if(gamesFilters.provider==='all' && gamesFilters.game==='all' && gamesFilters.category==='all') addDragEvents(tr, idx); else tr.querySelector('.drag-handle').classList.add('opacity-0','pointer-events-none');
                tbody.appendChild(tr);
            });
            updateKPIs(tCostUSD, tCostDA, tRev, tProfit);
        }

        // --- CANVA LOGIC ---
        function updateCanvaDashboard() {
            if(currentView !== 'canva') return;
            let tCostUSD=0, tCostDA=0, tRev=0, tProfit=0;
            const tbody = document.getElementById('canvaTableBody'); tbody.innerHTML = '';
            if(canvaData.length === 0) tbody.innerHTML = '<tr><td colspan="12" class="text-center py-8 text-slate-400">No subscriptions.</td></tr>';

            canvaData.forEach(item => {
                const costDA = item.buyDA !== undefined ? item.buyDA : (item.buyUSD * currentRate);
                const costUSD = currentRate > 0 ? (costDA / currentRate) : 0;
                const profit = item.sellDA - costDA;
                tCostUSD += costUSD; tCostDA += costDA; tRev += item.sellDA; tProfit += profit;
                
                const tr = document.createElement('tr'); tr.className = "hover:bg-slate-50 border-b border-slate-100 last:border-0";
                tr.innerHTML = `
                    <td class="px-2 py-1 text-center text-xs text-slate-400 font-mono"><input class="table-input num-input text-xs text-slate-400 w-12" value="${item.customId||'Auto'}" onchange="updCanva('${item.docId}','customId',this.value)"></td>
                    <td class="px-2 py-1"><input class="table-input font-medium w-32" value="${item.name}" onchange="updCanva('${item.docId}','name',this.value)"></td>
                    <td class="px-2 py-1"><input class="table-input text-slate-500 text-xs w-40" value="${item.email}" onchange="updCanva('${item.docId}','email',this.value)"></td>
                    <td class="px-2 py-1"><input type="date" class="table-input text-xs w-24" value="${item.startDate}" onchange="updCanva('${item.docId}','startDate',this.value)"></td>
                    <td class="px-2 py-1"><input type="date" class="table-input text-xs w-24" value="${item.endDate}" onchange="updCanva('${item.docId}','endDate',this.value)"></td>
                    <td class="px-2 py-1 text-right font-mono text-slate-500 w-20 text-xs">${costUSD.toFixed(2)}</td>
                    <td class="px-2 py-1"><input class="table-input num-input font-bold text-red-600 bg-red-50/50 w-20 text-xs" value="${costDA}" onchange="updCanva('${item.docId}','buyDA',this.value)"></td>
                    <td class="px-2 py-1 text-right font-mono text-blue-600 bg-blue-50/50 rounded font-medium text-xs w-20">${(currentRate>0?item.sellDA/currentRate:0).toFixed(2)}</td>
                    <td class="px-2 py-1"><input class="table-input num-input font-bold text-green-700 w-20 text-xs" value="${item.sellDA}" onchange="updCanva('${item.docId}','sellDA',this.value)"></td>
                    <td class="px-2 py-1 text-right font-bold text-slate-700 text-xs">${profit.toFixed(0)}</td>
                    <td class="px-2 py-1 text-right text-xs text-slate-500">${(item.sellDA>0?(profit/item.sellDA*100):0).toFixed(0)}%</td>
                    <td class="px-2 py-1 text-right"><button onclick="window.delCanva('${item.docId}')" class="text-red-500 hover:bg-red-50 p-1 rounded transition">&times;</button></td>
                `;
                tbody.appendChild(tr);
            });
            updateKPIs(tCostUSD, tCostDA, tRev, tProfit);
        }

        // --- HELPERS ---
        function updateKPIs(usd, da, rev, profit) {
            document.getElementById('kpi-cost-usd').textContent = '$' + usd.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('kpi-cost-da').textContent = da.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('kpi-revenue').textContent = rev.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('kpi-profit').textContent = profit.toLocaleString(undefined, {maximumFractionDigits: 0});
            const margin = rev > 0 ? (profit/rev)*100 : 0;
            document.getElementById('kpi-margin').textContent = margin.toFixed(1) + '%';
        }

        function toggleSidebar(show) {
            const sb = document.getElementById('sidebar'); const ol = document.getElementById('sidebar-overlay');
            if(show) { sb.classList.remove('-translate-x-full'); ol.classList.remove('hidden'); }
            else { sb.classList.add('-translate-x-full'); ol.classList.add('hidden'); }
        }

        function getVisibleData() {
            if(currentView === 'smm') {
                return smmData.filter(i => (smmFilters.platform==='all'||i.platform===smmFilters.platform) && (smmFilters.category==='all'||(i.category||"Gen")===smmFilters.category) && (smmFilters.type==='all'||(i.type||"")===smmFilters.type));
            } else if(currentView === 'games') {
                return gamesData.filter(i => (gamesFilters.game==='all'||(i.game||"Unk")===gamesFilters.game) && (gamesFilters.console==='all'||(i.console||"PC")===gamesFilters.console) && (gamesFilters.provider==='all'||i.provider===gamesFilters.provider) && (gamesFilters.category==='all'||(i.category||"General")===gamesFilters.category));
            } else if(currentView === 'accounts') {
                return accountsData.filter(i => (accountsFilters.platform==='all'||i.platform===accountsFilters.platform) && (accountsFilters.category==='all'||(i.category||"Gen")===accountsFilters.category) && (accountsFilters.type==='all'||(i.type||"")===accountsFilters.type));
            } else {
                return canvaData;
            }
        }
        function getGlobalData() {
            if(currentView === 'smm') return smmData;
            if(currentView === 'games') return gamesData;
            if(currentView === 'accounts') return accountsData;
            return canvaData;
        }

        window.updSMM = async (id, f, v) => { let val=v; if(['buyUSD','sellDA','qty','customId'].includes(f)) val=parseFloat(v)||0; await updateDoc(doc(db,'artifacts',appId,'users',userId,'services',id), {[f]:val}); };
        window.delSMM = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db,'artifacts',appId,'users',userId,'services',id)); };
        window.dupSMM = async (id) => { const item=smmData.find(i=>i.docId===id); const newItem={...item,customId:(Math.max(...smmData.map(i=>i.customId||0)))+1,sortOrder:smmData.length,createdAt:Date.now()}; delete newItem.docId; await addDoc(collection(db,'artifacts',appId,'users',userId,'services'),newItem); };
        
        window.updAccount = async (id, f, v) => { let val=v; if(['buyUSD','sellDA','qty','customId'].includes(f)) val=parseFloat(v)||0; await updateDoc(doc(db,'artifacts',appId,'users',userId,'accounts_services',id), {[f]:val}); };
        window.delAccount = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db,'artifacts',appId,'users',userId,'accounts_services',id)); };
        window.dupAccount = async (id) => { const item=accountsData.find(i=>i.docId===id); const newItem={...item,customId:(Math.max(...accountsData.map(i=>i.customId||0)))+1,sortOrder:accountsData.length,createdAt:Date.now()}; delete newItem.docId; await addDoc(collection(db,'artifacts',appId,'users',userId,'accounts_services'),newItem); };

        window.updCanva = async (id, f, v) => { let val=v; if(['buyUSD','sellDA','customId','buyDA'].includes(f)) val=parseFloat(v)||0; await updateDoc(doc(db,'artifacts',appId,'users',userId,'canva_services',id), {[f]:val}); };
        window.delCanva = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db,'artifacts',appId,'users',userId,'canva_services',id)); };
        window.updGame = async (id, f, v) => { let val=v; if(['buyUSD','sellDA','customId'].includes(f)) val=parseFloat(v)||0; await updateDoc(doc(db,'artifacts',appId,'users',userId,'games_services',id), {[f]:val}); };
        window.delGame = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db,'artifacts',appId,'users',userId,'games_services',id)); };
        window.deleteSale = async (id) => { if(confirm("Delete this sale record?")) { await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'sales_records', id)); } };

        // --- CHARTS & DRAG ---
        function initCharts() {
            if(!document.getElementById('smmChart')) return;
            Chart.defaults.font.family = "'Inter', sans-serif";
            smmChart = new Chart(document.getElementById('smmChart').getContext('2d'), { type: 'bar', data: { labels:[], datasets:[{label:'Cost',data:[],backgroundColor:'#cbd5e1'},{label:'Sell',data:[],backgroundColor:'#6366f1'}] }, options: { maintainAspectRatio:false, scales:{x:{grid:{display:false}},y:{beginAtZero:true}} } });
            smmDistChart = new Chart(document.getElementById('smmDistChart').getContext('2d'), { type: 'doughnut', data: { labels:[], datasets:[{data:[],backgroundColor:['#6366f1','#818cf8','#a5b4fc']}] }, options: { maintainAspectRatio:false, cutout:'70%' } });
        }
        function updateCharts(data) {
            if(!smmChart) return;
            // Only update charts if visible data has length
            if(data.length === 0) return;
            
            const top = [...data].sort((a,b)=> (b.sellDA-(b.buyUSD*currentRate)) - (a.sellDA-(a.buyUSD*currentRate))).slice(0,5);
            smmChart.data.labels = top.map(i=>i.service.substring(0,10)); smmChart.data.datasets[0].data = top.map(i=>i.buyUSD*currentRate); smmChart.data.datasets[1].data = top.map(i=>i.sellDA); smmChart.update();
            const plats = [...new Set(data.map(i=>i.platform))]; smmDistChart.data.labels = plats; smmDistChart.data.datasets[0].data = plats.map(p=>data.filter(i=>i.platform===p).length); smmDistChart.update();
        }
        function addDragEvents(row, idx) {
            row.setAttribute('draggable','false'); row.dataset.index = idx;
            const h = row.querySelector('.drag-handle');
            if(!h) return;
            h.onmouseenter=()=>row.setAttribute('draggable','true'); h.onmouseleave=()=>row.setAttribute('draggable','false'); h.onmousedown=()=>row.setAttribute('draggable','true');
            row.ondragstart = (e) => { dragSrcEl=row; dragSrcIndex=idx; row.classList.add('dragging'); e.dataTransfer.setData('text/plain', idx); };
            row.ondragover = (e) => { e.preventDefault(); return false; };
            row.ondragend = () => { row.classList.remove('dragging'); row.setAttribute('draggable','false'); };
            row.ondrop = async (e) => {
                e.stopPropagation();
                let allow = false;
                if(currentView === 'smm' && smmFilters.platform==='all' && smmFilters.category==='all') allow = true;
                if(currentView === 'games' && gamesFilters.provider==='all' && gamesFilters.game==='all' && gamesFilters.category==='all' && gamesFilters.console==='all') allow = true;
                if(currentView === 'accounts' && accountsFilters.platform==='all' && accountsFilters.category==='all') allow = true;
                
                if(!allow) { alert("Please clear filters to reorder items."); return false; }
                
                const toIdx = parseInt(row.dataset.index);
                if(dragSrcIndex > -1 && dragSrcIndex !== toIdx) {
                    await reorderItems(dragSrcIndex, toIdx);
                }
            };
        }

        async function reorderItems(fromIndex, toIndex) {
            const visibleList = getVisibleData(); // The array currently shown (potentially filtered)
            const globalList = getGlobalData();   // The full array from DB
            let collectionName;
            if (currentView === 'smm') collectionName = `services`;
            else if (currentView === 'games') collectionName = `games_services`;
            else if (currentView === 'accounts') collectionName = `accounts_services`;
            else collectionName = `canva_services`;

            // Identify items involved
            const itemMoved = visibleList[fromIndex];
            const itemTarget = visibleList[toIndex];

            const globalFromIdx = globalList.findIndex(i => i.docId === itemMoved.docId);
            let globalToIdx = globalList.findIndex(i => i.docId === itemTarget.docId);

            if (globalFromIdx === -1 || globalToIdx === -1) return;

            const [removedItem] = globalList.splice(globalFromIdx, 1);
            globalToIdx = globalList.findIndex(i => i.docId === itemTarget.docId);
            
            if (fromIndex < toIndex) {
                // Dragging down: Insert AFTER the target in the global list
                globalList.splice(globalToIdx + 1, 0, removedItem);
            } else {
                // Dragging up: Insert BEFORE the target
                globalList.splice(globalToIdx, 0, removedItem);
            }
            
            // Batch update all sortOrders
            const batch = writeBatch(db);
            globalList.forEach((item, index) => {
                 item.sortOrder = index;
                 if (item.docId) {
                     const ref = doc(db, 'artifacts', appId, 'users', userId, collectionName, item.docId);
                     batch.update(ref, { sortOrder: index });
                 }
            });
            try { await batch.commit(); } catch(err) { console.error("Reorder failed", err); }
        }
    </script>
</body>
</html>
