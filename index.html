<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Pricing Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .chart-container { position: relative; width: 100%; max-width: 100%; height: 300px; margin: 0 auto; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }

        .custom-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }

        .table-input {
            background: #fff; border: 1px solid #e2e8f0; border-radius: 4px; padding: 4px 8px; width: 100%; transition: all 0.2s; font-size: 0.875rem; color: #0f172a;
        }
        .table-input:hover { border-color: #cbd5e1; }
        .table-input:focus { border-color: #6366f1; outline: none; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1); }
        .table-input.num-input { text-align: right; font-family: 'Inter', monospace; }

        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .draggable-row.dragging { opacity: 0.5; background-color: #eff6ff; border: 2px dashed #6366f1; }
        .drag-handle { cursor: grab; touch-action: none; }
        .drag-handle:active { cursor: grabbing; }
    </style>
</head>
<body class="bg-[#fafaf9] text-[#1c1917] antialiased min-h-screen flex flex-col overflow-hidden">

    <!-- AUTH SCREEN -->
    <div id="auth-container" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-indigo-600 to-blue-500">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden mx-4 p-8">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-slate-900">Dashboard Login</h1>
                <p class="text-slate-500 text-sm mt-1">Manage your SMM & Canva services</p>
            </div>
            <div id="auth-error" class="hidden bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4 text-center"></div>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-500 uppercase">Email</label><input type="email" id="auth-email" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase">Password</label><input type="password" id="auth-password" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"></div>
                <div class="pt-4 flex flex-col gap-3">
                    <button id="loginBtn" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg transition">Login</button>
                    <button id="registerBtn" class="w-full py-3 bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 rounded-xl font-bold transition">Create Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SIDEBAR & OVERLAY -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden backdrop-blur-sm transition-opacity"></div>
    <div id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-white border-r border-[#e7e5e4] z-50 transform -translate-x-full shadow-2xl flex flex-col">
        <div class="p-6 border-b border-[#e7e5e4] flex justify-between items-center">
            <h2 class="text-lg font-bold text-[#1c1917]">Navigation</h2>
            <button id="closeSidebarBtn" class="text-slate-400 hover:text-red-500 text-2xl">&times;</button>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchView('smm')" id="nav-smm" class="w-full text-left px-4 py-3 rounded-lg font-medium transition flex items-center gap-3 bg-indigo-50 text-indigo-700">
                <span class="text-xl">üì±</span> Social Media
            </button>
            <button onclick="switchView('games')" id="nav-games" class="w-full text-left px-4 py-3 rounded-lg font-medium text-slate-600 hover:bg-[#f5f5f4] transition flex items-center gap-3">
                <span class="text-xl">üéÆ</span> Games Top-up
            </button>
            <button onclick="switchView('canva')" id="nav-canva" class="w-full text-left px-4 py-3 rounded-lg font-medium text-slate-600 hover:bg-[#f5f5f4] transition flex items-center gap-3">
                <span class="text-xl">üé®</span> Canva Pro
            </button>
        </nav>
        <div class="p-4 border-t border-[#e7e5e4]">
            <button id="logoutBtn" class="w-full px-4 py-2 text-sm font-medium text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition">Sign Out</button>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="hidden flex flex-col h-screen w-full overflow-hidden">

        <!-- ADD ITEM MODAL -->
        <div id="addModal" class="fixed inset-0 z-[100] hidden bg-black/20 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden border border-[#e7e5e4] flex flex-col max-h-[90vh]">
                <div class="px-6 py-4 border-b border-[#e7e5e4] flex justify-between items-center bg-[#fafaf9]">
                    <h3 class="font-bold text-lg text-[#1c1917]" id="modalTitle">Add New Service</h3>
                    <button id="closeModalBtn" class="text-[#a8a29e] hover:text-red-500 text-2xl leading-none">&times;</button>
                </div>
                <div class="p-6 space-y-4 overflow-y-auto custom-scroll">
                    <div class="grid grid-cols-4 gap-4">
                        <div class="col-span-1"><label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">ID</label><input type="number" id="newId" class="w-full p-2 border border-[#e7e5e4] rounded-lg outline-none"></div>
                        <div class="col-span-3 smm-field"><label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Platform</label><input type="text" id="newPlatform" class="w-full p-2 border border-[#e7e5e4] rounded-lg outline-none"></div>
                        <div class="col-span-3 canva-field hidden"><label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Customer Name</label><input type="text" id="newName" class="w-full p-2 border border-[#e7e5e4] rounded-lg outline-none"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 smm-field">
                        <div><label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Category</label><input type="text" id="newCategory" list="catList" class="w-full p-2 border border-[#e7e5e4] rounded-lg outline-none"><datalist id="catList"><option value="Followers"><option value="Likes"></datalist></div>
                        <div><label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Type (Tag)</label><input type="text" id="newType" class="w-full p-2 border border-[#e7e5e4] rounded-lg outline-none"></div>
                    </div>
                    <!-- Game Fields -->
                    <div class="grid grid-cols-2 gap-4 game-field hidden">
                        <div><label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Provider</label><input type="text" id="newProvider" placeholder="Shop2Game..." class="w-full p-2 border border-[#e7e5e4] rounded-lg outline-none"></div>
                        <div><label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Game Name</label><input type="text" id="newGameName" placeholder="Free Fire..." class="w-full p-2 border border-[#e7e5e4] rounded-lg outline-none"></div>
                    </div>
                    <div class="game-field hidden"><label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Amount (Coins/Gems)</label><input type="text" id="newAmount" placeholder="100 Diamonds" class="w-full p-2 border border-[#e7e5e4] rounded-lg outline-none"></div>

                    <div class="canva-field hidden"><label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Customer Email</label><input type="email" id="newEmail" class="w-full p-2 border border-[#e7e5e4] rounded-lg outline-none"></div>
                    <div class="smm-field"><label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Service Name</label><input type="text" id="newService" class="w-full p-2 border border-[#e7e5e4] rounded-lg outline-none"></div>
                    <div class="grid grid-cols-2 gap-4 canva-field hidden">
                        <div><label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Start Date</label><input type="date" id="newStartDate" class="w-full p-2 border border-[#e7e5e4] rounded-lg outline-none"></div>
                        <div><label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">End Date</label><input type="date" id="newEndDate" class="w-full p-2 border border-[#e7e5e4] rounded-lg outline-none"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="smm-field game-field"><label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Cost ($)</label><input type="number" id="newCost" step="0.01" class="w-full p-2 border border-[#e7e5e4] rounded-lg outline-none"></div>
                        <div class="canva-field hidden"><label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Cost (DA)</label><input type="number" id="newCostDA" step="10" class="w-full p-2 border border-[#e7e5e4] rounded-lg outline-none"></div>
                        <div><label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Sell (DA)</label><input type="number" id="newSell" step="10" class="w-full p-2 border border-[#e7e5e4] rounded-lg outline-none"></div>
                        <div class="smm-field"><label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Qty</label><input type="number" id="newQty" value="1" class="w-full p-2 border border-[#e7e5e4] rounded-lg outline-none"></div>
                    </div>
                    <div class="smm-field game-field"><label class="block text-xs font-bold text-[#a8a29e] uppercase mb-1">Link</label><input type="url" id="newLink" class="w-full p-2 border border-[#e7e5e4] rounded-lg outline-none text-blue-600"></div>
                </div>
                <div class="px-6 py-4 bg-[#fafaf9] flex justify-end gap-3 border-t border-[#e7e5e4]">
                    <button id="cancelModalBtn" class="px-4 py-2 text-sm font-medium text-[#57534e] hover:bg-[#e7e5e4] rounded-lg">Cancel</button>
                    <button id="saveServiceBtn" class="px-4 py-2 text-sm font-bold text-white bg-[#6366f1] hover:bg-[#4f46e5] rounded-lg shadow-sm">Save Service</button>
                </div>
            </div>
        </div>

        <!-- HEADER -->
        <header class="bg-white border-b border-[#e7e5e4] flex-shrink-0 z-30 shadow-sm relative">
            <div class="max-w-[98%] mx-auto px-4 py-4 flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <button id="sidebarToggle" class="text-slate-500 hover:text-indigo-600 p-1"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
                    <div>
                        <h1 class="text-2xl font-bold tracking-tight text-[#1c1917]" id="pageTitle">Social Media Services</h1>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs text-[#57534e] font-medium bg-[#f5f5f4] px-2 py-0.5 rounded" id="userEmailDisplay">...</span>
                        </div>
                    </div>
                </div>
                <div class="bg-[#f5f5f4] rounded-lg p-2 flex items-center gap-4 border border-[#e7e5e4]">
                    <div class="text-[10px] font-bold text-[#57534e] uppercase tracking-wider">USD to DA</div>
                    <div class="flex items-center gap-2">
                        <input type="range" id="rateSlider" min="200" max="300" value="255" class="w-24 h-2 bg-[#d6d3d1] rounded-lg cursor-pointer accent-[#6366f1]">
                        <div class="bg-white px-2 py-1 rounded border border-[#e7e5e4] font-mono font-bold text-[#6366f1] text-sm" id="rateDisplay">255.0</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- CONTENT -->
        <main class="flex-1 overflow-y-auto custom-scroll w-full bg-[#f8fafc]">
            <div class="max-w-[98%] mx-auto px-4 py-6 space-y-6">
                <!-- KPIS -->
                <section class="grid grid-cols-2 lg:grid-cols-5 gap-3">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-[#e7e5e4]"><div class="text-[10px] font-bold text-[#a8a29e] uppercase">Total Cost ($)</div><div class="text-xl font-bold text-slate-700" id="kpi-cost-usd">$0.00</div></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-[#e7e5e4]"><div class="text-[10px] font-bold text-[#a8a29e] uppercase">Total Cost (DA)</div><div class="text-xl font-bold text-red-600" id="kpi-cost-da">0</div></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-[#e7e5e4]"><div class="text-[10px] font-bold text-[#a8a29e] uppercase">Revenue (DA)</div><div class="text-xl font-bold text-[#1c1917]" id="kpi-revenue">0</div></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-[#e7e5e4]"><div class="text-[10px] font-bold text-[#a8a29e] uppercase">Profit (DA)</div><div class="text-xl font-bold text-[#6366f1]" id="kpi-profit">0</div></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-[#e7e5e4]"><div class="text-[10px] font-bold text-[#a8a29e] uppercase">Margin</div><div class="text-xl font-bold text-emerald-600" id="kpi-margin">0%</div></div>
                </section>

                <!-- SECTION: SMM -->
                <div id="view-smm" class="space-y-6">
                    <div class="flex flex-col md:flex-row justify-between gap-4 bg-white p-4 rounded-xl border border-[#e7e5e4] shadow-sm">
                        <div class="flex flex-wrap gap-2 items-center">
                            <select id="platformFilter" class="bg-[#f5f5f4] text-sm font-medium rounded-lg p-2 outline-none"><option value="all">All Platforms</option></select>
                            <select id="categoryFilter" class="bg-[#f5f5f4] text-sm font-medium rounded-lg p-2 outline-none"><option value="all">All Categories</option></select>
                            <select id="typeFilter" class="bg-[#f5f5f4] text-sm font-medium rounded-lg p-2 outline-none"><option value="all">All Types</option></select>
                        </div>
                        <button onclick="window.openAddModal()" class="flex items-center gap-2 px-4 py-2 text-sm font-bold text-white bg-[#1c1917] hover:bg-[#57534e] rounded-lg shadow-sm whitespace-nowrap"><span>+ Add Service</span></button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-4 rounded-xl border border-[#e7e5e4] h-80"><canvas id="smmChart"></canvas></div>
                        <div class="bg-white p-4 rounded-xl border border-[#e7e5e4] h-80"><canvas id="smmDistChart"></canvas></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-[#e7e5e4] overflow-hidden">
                        <div class="overflow-x-auto custom-scroll">
                            <table class="w-full text-left text-sm" id="smmTable">
                                <thead class="bg-[#fafaf9] text-[#57534e] font-semibold uppercase text-xs tracking-wider border-b border-[#e7e5e4]">
                                    <tr>
                                        <th class="w-8 px-2 py-3"></th>
                                        <th class="px-3 py-3 w-24 text-center">ID</th>
                                        <th class="px-3 py-3 min-w-[120px]">Platform</th><th class="px-3 py-3 min-w-[160px]">Category</th><th class="px-3 py-3 min-w-[140px]">Type</th><th class="px-3 py-3 min-w-[200px]">Service</th>
                                        <th class="px-3 py-3 text-right w-32">Cost $</th><th class="px-3 py-3 text-right w-20 bg-red-50">Cost DA</th><th class="px-3 py-3 text-right w-20 bg-blue-50">Sell $</th><th class="px-3 py-3 text-right w-32 bg-green-50">Sell DA</th><th class="px-3 py-3 text-center w-12">Qty</th><th class="px-3 py-3 text-right">Profit</th><th class="px-3 py-3 text-right">Margin</th><th class="px-3 py-3 text-right w-24">Act</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-[#e7e5e4]" id="smmTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SECTION: GAMES -->
                <div id="view-games" class="hidden space-y-6">
                    <div class="flex flex-col md:flex-row justify-between gap-4 bg-white p-4 rounded-xl border border-[#e7e5e4] shadow-sm">
                        <div class="flex flex-wrap gap-2 items-center">
                            <select id="gameProviderFilter" class="bg-[#f5f5f4] text-sm font-medium rounded-lg p-2 outline-none"><option value="all">All Providers</option></select>
                            <div class="h-4 w-px bg-[#e7e5e4]"></div>
                            <select id="gameNameFilter" class="bg-[#f5f5f4] text-sm font-medium rounded-lg p-2 outline-none"><option value="all">All Games</option></select>
                        </div>
                        <button onclick="window.openAddModal()" class="flex items-center gap-2 px-4 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-sm"><span>+ Add Game Topup</span></button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-[#e7e5e4] overflow-hidden">
                        <div class="overflow-x-auto custom-scroll">
                            <table class="w-full text-left text-sm" id="gamesTable">
                                <thead class="bg-[#fafaf9] text-[#57534e] font-semibold uppercase text-xs tracking-wider border-b border-[#e7e5e4]">
                                    <tr>
                                        <th class="w-8 px-2 py-3"></th> <!-- Drag Handle -->
                                        <th class="px-3 py-3 w-24 text-center">ID</th>
                                        <th class="px-3 py-3 min-w-[150px]">Provider</th>
                                        <th class="px-3 py-3 min-w-[200px]">Game Name</th>
                                        <th class="px-3 py-3 min-w-[150px]">Amount</th>
                                        <th class="px-3 py-3 text-right w-32">Cost $</th>
                                        <th class="px-3 py-3 text-right w-24 bg-red-50">Cost DA</th>
                                        <th class="px-3 py-3 text-right w-24 bg-blue-50">Sell $</th>
                                        <th class="px-3 py-3 text-right w-32 bg-green-50">Sell DA</th>
                                        <th class="px-3 py-3 text-right">Profit</th>
                                        <th class="px-3 py-3 text-right">Margin</th>
                                        <th class="px-3 py-3 text-right w-24">Act</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-[#e7e5e4]" id="gamesTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SECTION: CANVA -->
                <div id="view-canva" class="hidden space-y-6">
                    <div class="flex justify-end bg-white p-4 rounded-xl border border-[#e7e5e4] shadow-sm"><button onclick="window.openAddModal()" class="flex items-center gap-2 px-4 py-2 text-sm font-bold text-white bg-[#6366f1] hover:bg-[#4f46e5] rounded-lg shadow-sm"><span>+ Add Subscription</span></button></div>
                    <div class="bg-white rounded-xl shadow-sm border border-[#e7e5e4] overflow-hidden">
                        <div class="overflow-x-auto custom-scroll">
                            <table class="w-full text-left text-sm" id="canvaTable">
                                <thead class="bg-[#fafaf9] text-[#57534e] font-semibold uppercase text-xs tracking-wider border-b border-[#e7e5e4]">
                                    <tr>
                                        <th class="px-3 py-3 w-24 text-center">ID</th><th class="px-3 py-3 min-w-[150px]">Customer Name</th><th class="px-3 py-3 min-w-[200px]">Email</th><th class="px-3 py-3 w-32">Start Date</th><th class="px-3 py-3 w-32">End Date</th><th class="px-3 py-3 text-right w-32">Cost $</th><th class="px-3 py-3 text-right w-24 bg-red-50">Cost DA</th><th class="px-3 py-3 text-right w-24 bg-blue-50">Sell $</th><th class="px-3 py-3 text-right w-32 bg-green-50">Sell DA</th><th class="px-3 py-3 text-right">Profit</th><th class="px-3 py-3 text-right">Margin</th><th class="px-3 py-3 text-right w-16">Act</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-[#e7e5e4]" id="canvaTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCdB5SZ9Xi6MVZl-DsmTgWjJPK5EId-4F8", authDomain: "dized-box.firebaseapp.com", projectId: "dized-box", storageBucket: "dized-box.firebasestorage.app", messagingSenderId: "163199308320", appId: "1:163199308320:web:7e8217dabae7668d016245", measurementId: "G-Q9GFSXFZG8" };
        const appId = 'SMM_Pricing_Dashboard_App';
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

        // --- STATE ---
        let userId = null;
        let currentRate = 255;
        let currentView = 'smm';
        let smmData = [];
        let canvaData = [];
        let gamesData = [];
        let smmFilters = { platform: 'all', category: 'all', type: 'all' };
        let gamesFilters = { provider: 'all', game: 'all' }; // NEW
        let smmChart = null; let smmDistChart = null;
        let dragSrcEl = null; let dragSrcIndex = -1;

        // --- DOM ---
        const nav = { smm: document.getElementById('nav-smm'), canva: document.getElementById('nav-canva'), games: document.getElementById('nav-games') };
        const views = { smm: document.getElementById('view-smm'), canva: document.getElementById('view-canva'), games: document.getElementById('view-games') };
        const pageTitle = document.getElementById('pageTitle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');

        // --- AUTH ---
        window.handleLogin = async function() {
            const email = document.getElementById('auth-email').value; const pass = document.getElementById('auth-password').value; 
            try { await signInWithEmailAndPassword(auth, email, pass); } catch (error) { document.getElementById('auth-error').textContent = error.message; document.getElementById('auth-error').classList.remove('hidden'); }
        }
        window.handleRegister = async function() {
            const email = document.getElementById('auth-email').value; const pass = document.getElementById('auth-password').value; 
            try { await createUserWithEmailAndPassword(auth, email, pass); } catch (error) { document.getElementById('auth-error').textContent = error.message; document.getElementById('auth-error').classList.remove('hidden'); }
        }
        window.handleLogout = function() { signOut(auth); }

        onAuthStateChanged(auth, (user) => {
            if (user) { userId = user.uid; document.getElementById('userEmailDisplay').textContent = user.email; document.getElementById('auth-container').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); setupRealtimeListeners(); } 
            else { userId = null; document.getElementById('auth-container').classList.remove('hidden'); document.getElementById('app-container').classList.add('hidden'); smmData = []; canvaData = []; gamesData = []; }
        });

        // --- INIT & LISTENERS ---
        window.addEventListener('load', () => { initCharts(); setupEventListeners(); });

        function setupEventListeners() {
            document.getElementById('loginBtn').onclick = window.handleLogin;
            document.getElementById('registerBtn').onclick = window.handleRegister;
            document.getElementById('logoutBtn').onclick = window.handleLogout;
            
            document.getElementById('rateSlider').addEventListener('input', (e) => {
                const v = parseInt(e.target.value); document.getElementById('rateDisplay').textContent = v.toFixed(1); currentRate = v; updateDashboard(); updateCanvaDashboard(); updateGamesDashboard();
                if(userId) setDoc(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'global'), { rate: v }, { merge: true });
            });
            document.getElementById('platformFilter').addEventListener('change', (e) => { smmFilters.platform = e.target.value; smmFilters.category='all'; updateSMMCategoryFilter(); updateDashboard(); });
            document.getElementById('categoryFilter').addEventListener('change', (e) => { smmFilters.category = e.target.value; updateSMMTypeFilter(); updateDashboard(); });
            document.getElementById('typeFilter').addEventListener('change', (e) => { smmFilters.type = e.target.value; updateDashboard(); });
            
            // GAMES FILTERS
            document.getElementById('gameProviderFilter').addEventListener('change', (e) => { gamesFilters.provider = e.target.value; updateGamesGameFilter(); updateGamesDashboard(); });
            document.getElementById('gameNameFilter').addEventListener('change', (e) => { gamesFilters.game = e.target.value; updateGamesDashboard(); });
            
            document.getElementById('closeModalBtn').onclick = () => document.getElementById('addModal').classList.add('hidden');
            document.getElementById('cancelModalBtn').onclick = () => document.getElementById('addModal').classList.add('hidden');
            document.getElementById('saveServiceBtn').onclick = window.saveNewService;
            
            document.getElementById('sidebarToggle').onclick = () => toggleSidebar(true);
            document.getElementById('closeSidebarBtn').onclick = () => toggleSidebar(false);
            document.getElementById('sidebar-overlay').onclick = () => toggleSidebar(false);
        }

        // --- GLOBAL WINDOW EXPORTS ---
        window.openAddModal = () => {
            document.getElementById('addModal').classList.remove('hidden');
            let list = [];
            if (currentView === 'smm') list = smmData;
            else if (currentView === 'canva') list = canvaData;
            else list = gamesData;

            const maxId = list.length > 0 ? Math.max(...list.map(i => i.customId || 0)) : 100;
            document.getElementById('newId').value = maxId + 1;
            
            const smmFields = document.querySelectorAll('.smm-field'); 
            const canvaFields = document.querySelectorAll('.canva-field');
            const gameFields = document.querySelectorAll('.game-field');

            smmFields.forEach(el => el.classList.add('hidden'));
            canvaFields.forEach(el => el.classList.add('hidden'));
            gameFields.forEach(el => el.classList.add('hidden'));

            if(currentView === 'smm') {
                document.getElementById('modalTitle').textContent = "Add Social Media Service";
                smmFields.forEach(el => el.classList.remove('hidden'));
            } else if (currentView === 'canva') {
                document.getElementById('modalTitle').textContent = "Add Canva Subscription";
                canvaFields.forEach(el => el.classList.remove('hidden'));
            } else {
                document.getElementById('modalTitle').textContent = "Add Game Top-up";
                gameFields.forEach(el => el.classList.remove('hidden'));
            }
        };

        window.switchView = (view) => {
            currentView = view; toggleSidebar(false);
            views.smm.classList.add('hidden'); views.canva.classList.add('hidden'); views.games.classList.add('hidden');
            nav.smm.classList.remove('bg-indigo-50', 'text-indigo-700'); nav.smm.classList.add('text-slate-600');
            nav.canva.classList.remove('bg-indigo-50', 'text-indigo-700'); nav.canva.classList.add('text-slate-600');
            nav.games.classList.remove('bg-indigo-50', 'text-indigo-700'); nav.games.classList.add('text-slate-600');

            if(view === 'smm') {
                pageTitle.textContent = "Social Media Services"; views.smm.classList.remove('hidden');
                nav.smm.classList.add('bg-indigo-50', 'text-indigo-700'); nav.smm.classList.remove('text-slate-600');
                updateDashboard();
            } else if(view === 'canva') {
                pageTitle.textContent = "Canva Pro Invitations"; views.canva.classList.remove('hidden');
                nav.canva.classList.add('bg-indigo-50', 'text-indigo-700'); nav.canva.classList.remove('text-slate-600');
                updateCanvaDashboard();
            } else {
                pageTitle.textContent = "Games Top-up"; views.games.classList.remove('hidden');
                nav.games.classList.add('bg-indigo-50', 'text-indigo-700'); nav.games.classList.remove('text-slate-600');
                updateGamesDashboard();
            }
        };

        window.saveNewService = async () => {
            if(!userId) return;
            const common = {
                customId: parseInt(document.getElementById('newId').value) || 0,
                createdAt: Date.now()
            };
            try {
                if(currentView === 'smm') {
                    await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'services'), { ...common,
                        platform: document.getElementById('newPlatform').value, category: document.getElementById('newCategory').value,
                        type: document.getElementById('newType').value, service: document.getElementById('newService').value,
                        buyUSD: parseFloat(document.getElementById('newCost').value) || 0,
                        sellDA: parseFloat(document.getElementById('newSell').value) || 0,
                        qty: parseInt(document.getElementById('newQty').value)||1, link: document.getElementById('newLink').value, sortOrder: smmData.length
                    });
                } else if(currentView === 'canva') {
                    await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'canva_services'), { ...common,
                        name: document.getElementById('newName').value, email: document.getElementById('newEmail').value,
                        startDate: document.getElementById('newStartDate').value, endDate: document.getElementById('newEndDate').value,
                        buyDA: parseFloat(document.getElementById('newCostDA').value) || 0,
                        sellDA: parseFloat(document.getElementById('newSell').value) || 0
                    });
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'games_services'), { ...common,
                        provider: document.getElementById('newProvider').value, game: document.getElementById('newGameName').value,
                        amount: document.getElementById('newAmount').value,
                        buyUSD: parseFloat(document.getElementById('newCost').value) || 0,
                        sellDA: parseFloat(document.getElementById('newSell').value) || 0,
                        link: document.getElementById('newLink').value, sortOrder: gamesData.length
                    });
                }
                document.getElementById('addModal').classList.add('hidden');
            } catch(e) { console.error(e); alert("Save failed"); }
        };

        // --- DATA & UI UPDATES ---
        function setupRealtimeListeners() {
            const settingsDoc = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'global');
            onSnapshot(settingsDoc, (s) => { if(s.exists()) { currentRate = s.data().rate || 255; document.getElementById('rateSlider').value = currentRate; document.getElementById('rateDisplay').textContent = currentRate.toFixed(1); updateDashboard(); updateCanvaDashboard(); updateGamesDashboard(); } else setDoc(settingsDoc, { rate: 255 }, { merge: true }); });
            
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'services'), (s) => {
                smmData = []; s.forEach(d => smmData.push({...d.data(), docId: d.id}));
                smmData.sort((a, b) => {
                    const orderA = a.sortOrder !== undefined ? a.sortOrder : (a.createdAt || 0);
                    const orderB = b.sortOrder !== undefined ? b.sortOrder : (b.createdAt || 0);
                    return orderA - orderB;
                });
                updateSMMFilters(); updateDashboard();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'canva_services'), (s) => {
                canvaData = []; s.forEach(d => canvaData.push({...d.data(), docId: d.id}));
                canvaData.sort((a, b) => new Date(b.endDate || 0) - new Date(a.endDate || 0));
                updateCanvaDashboard();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'games_services'), (s) => {
                gamesData = []; s.forEach(d => gamesData.push({...d.data(), docId: d.id}));
                gamesData.sort((a, b) => {
                    const orderA = a.sortOrder !== undefined ? a.sortOrder : (a.createdAt || 0);
                    const orderB = b.sortOrder !== undefined ? b.sortOrder : (b.createdAt || 0);
                    return orderA - orderB;
                });
                updateGamesFilters(); updateGamesDashboard();
            });
        }

        // --- SMM LOGIC ---
        function updateSMMFilters() {
            const plats = [...new Set(smmData.map(i => i.platform || "Uncat"))].sort();
            const pf = document.getElementById('platformFilter');
            pf.innerHTML = '<option value="all">All Platforms</option>' + plats.map(p => `<option value="${p}">${p}</option>`).join('');
            if(plats.includes(smmFilters.platform)) pf.value = smmFilters.platform;
            updateSMMCategoryFilter();
        }
        function updateSMMCategoryFilter() {
            const plat = document.getElementById('platformFilter').value;
            let cats = plat === 'all' ? [...new Set(smmData.map(i => i.category || "Gen"))] : [...new Set(smmData.filter(i => i.platform === plat).map(i => i.category || "Gen"))];
            const cf = document.getElementById('categoryFilter');
            cf.innerHTML = '<option value="all">All Categories</option>' + cats.sort().map(c => `<option value="${c}">${c}</option>`).join('');
            if(cats.includes(smmFilters.category)) cf.value = smmFilters.category;
            updateSMMTypeFilter();
        }
        function updateSMMTypeFilter() {
            const plat = document.getElementById('platformFilter').value; const cat = document.getElementById('categoryFilter').value;
            let d = smmData; if(plat !== 'all') d = d.filter(i => i.platform === plat); if(cat !== 'all') d = d.filter(i => (i.category||"Gen") === cat);
            const types = [...new Set(d.map(i => i.type || ""))].filter(t => t !== "").sort();
            const tf = document.getElementById('typeFilter');
            tf.innerHTML = '<option value="all">All Types</option>' + types.map(t => `<option value="${t}">${t}</option>`).join('');
            if(types.includes(smmFilters.type)) tf.value = smmFilters.type;
        }

        // --- GAMES FILTERS ---
        function updateGamesFilters() {
            const provs = [...new Set(gamesData.map(i => i.provider || "Unk"))].sort();
            const pf = document.getElementById('gameProviderFilter');
            pf.innerHTML = '<option value="all">All Providers</option>' + provs.map(p => `<option value="${p}">${p}</option>`).join('');
            if(provs.includes(gamesFilters.provider)) pf.value = gamesFilters.provider;
            updateGamesGameFilter();
        }
        function updateGamesGameFilter() {
            const prov = document.getElementById('gameProviderFilter').value;
            let games = prov === 'all' ? [...new Set(gamesData.map(i => i.game || "Unk"))] : [...new Set(gamesData.filter(i => i.provider === prov).map(i => i.game || "Unk"))];
            const gf = document.getElementById('gameNameFilter');
            gf.innerHTML = '<option value="all">All Games</option>' + games.sort().map(g => `<option value="${g}">${g}</option>`).join('');
            if(games.includes(gamesFilters.game)) gf.value = gamesFilters.game;
        }

        // --- UPDATE DASHBOARDS ---
        function updateDashboard() {
            if(currentView !== 'smm') return;
            const visible = smmData.filter(i => (smmFilters.platform==='all'||i.platform===smmFilters.platform) && (smmFilters.category==='all'||(i.category||"Gen")===smmFilters.category) && (smmFilters.type==='all'||(i.type||"")===smmFilters.type));
            let tCostUSD=0, tCostDA=0, tRev=0, tProfit=0;
            const tbody = document.getElementById('smmTableBody'); tbody.innerHTML = '';
            if(visible.length === 0) tbody.innerHTML = '<tr><td colspan="14" class="text-center py-8 text-slate-400">No items.</td></tr>';
            visible.forEach((item, idx) => {
                const qty = item.qty||1; const costDA = item.buyUSD*currentRate; const profit = (item.sellDA - costDA) * qty;
                tCostUSD += item.buyUSD*qty; tCostDA += costDA*qty; tRev += item.sellDA*qty; tProfit += profit;
                const tr = document.createElement('tr'); tr.className = "hover:bg-slate-50 border-b border-slate-100 last:border-0 draggable-row group";
                let btns = `<button onclick="window.dupSMM('${item.docId}')" class="text-indigo-500 hover:bg-indigo-50 p-1 mr-1">‚ùê</button><button onclick="window.delSMM('${item.docId}')" class="text-red-500 hover:bg-red-50 p-1">&times;</button>`;
                if(item.link) btns = `<a href="${item.link}" target="_blank" class="text-blue-500 hover:bg-blue-50 p-1 mr-1">‚Üó</a>` + btns;
                tr.innerHTML = `
                    <td class="px-2 py-2 text-center drag-handle text-slate-300 hover:text-slate-600"><span class="text-xl">‚â°</span></td>
                    <td class="px-3 py-2"><input class="table-input num-input text-xs text-slate-400 w-24" value="${item.customId||0}" onchange="updSMM('${item.docId}','customId',this.value)"></td>
                    <td class="px-3 py-2"><input class="table-input font-medium" value="${item.platform}" onchange="updSMM('${item.docId}','platform',this.value)"></td>
                    <td class="px-3 py-2"><input class="table-input text-slate-500" value="${item.category||''}" onchange="updSMM('${item.docId}','category',this.value)"></td>
                    <td class="px-3 py-2"><input class="table-input text-xs text-slate-400" value="${item.type||''}" onchange="updSMM('${item.docId}','type',this.value)"></td>
                    <td class="px-3 py-2"><input class="table-input" value="${item.service}" onchange="updSMM('${item.docId}','service',this.value)"></td>
                    <td class="px-3 py-2"><input class="table-input num-input w-32" value="${item.buyUSD}" onchange="updSMM('${item.docId}','buyUSD',this.value)"></td>
                    <td class="px-3 py-2 text-right font-mono text-red-600 bg-red-50/50 rounded">${costDA.toFixed(0)}</td>
                    <td class="px-3 py-2 text-right font-mono text-blue-600 bg-blue-50/50 rounded">${(currentRate>0?item.sellDA/currentRate:0).toFixed(2)}</td>
                    <td class="px-3 py-2"><input class="table-input num-input font-bold text-green-700 w-32" value="${item.sellDA}" onchange="updSMM('${item.docId}','sellDA',this.value)"></td>
                    <td class="px-3 py-2"><input class="table-input num-input" value="${qty}" onchange="updSMM('${item.docId}','qty',this.value)"></td>
                    <td class="px-3 py-2 text-right font-bold ${profit>=0?'text-indigo-600':'text-red-500'}">${profit.toFixed(0)}</td>
                    <td class="px-3 py-2 text-right text-xs">${(item.sellDA>0?(profit/(item.sellDA*qty)*100):0).toFixed(0)}%</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${btns}</td>`;
                if(smmFilters.platform==='all' && smmFilters.category==='all') addDragEvents(tr, idx); else tr.querySelector('.drag-handle').classList.add('opacity-0','pointer-events-none');
                tbody.appendChild(tr);
            });
            updateKPIs(tCostUSD, tCostDA, tRev, tProfit); updateCharts(visible);
        }

        function updateGamesDashboard() {
            if(currentView !== 'games') return;
            const visible = gamesData.filter(i => (gamesFilters.provider==='all'||i.provider===gamesFilters.provider) && (gamesFilters.game==='all'||(i.game||"Unk")===gamesFilters.game));
            let tCostUSD=0, tCostDA=0, tRev=0, tProfit=0;
            const tbody = document.getElementById('gamesTableBody'); tbody.innerHTML = '';
            if(visible.length === 0) tbody.innerHTML = '<tr><td colspan="11" class="text-center py-8 text-slate-400">No games found.</td></tr>';
            visible.forEach((item, idx) => {
                const costDA = item.buyUSD * currentRate; const profit = item.sellDA - costDA;
                tCostUSD += item.buyUSD; tCostDA += costDA; tRev += item.sellDA; tProfit += profit;
                let btns = `<button onclick="window.delGame('${item.docId}')" class="text-red-500 hover:bg-red-50 p-1 rounded">&times;</button>`;
                if(item.link) btns = `<a href="${item.link}" target="_blank" class="text-blue-500 hover:bg-blue-50 p-1 mr-1">‚Üó</a>` + btns;
                const tr = document.createElement('tr'); tr.className = "hover:bg-slate-50 border-b border-slate-100 last:border-0 draggable-row group";
                tr.innerHTML = `
                    <td class="px-2 py-2 text-center drag-handle text-slate-300 hover:text-slate-600"><span class="text-xl">‚â°</span></td>
                    <td class="px-3 py-2"><input class="table-input num-input text-xs text-slate-400 w-24" value="${item.customId||0}" onchange="updGame('${item.docId}','customId',this.value)"></td>
                    <td class="px-3 py-2"><input class="table-input font-medium" value="${item.provider}" onchange="updGame('${item.docId}','provider',this.value)"></td>
                    <td class="px-3 py-2"><input class="table-input" value="${item.game}" onchange="updGame('${item.docId}','game',this.value)"></td>
                    <td class="px-3 py-2"><input class="table-input text-slate-500" value="${item.amount}" onchange="updGame('${item.docId}','amount',this.value)"></td>
                    <td class="px-3 py-2"><input class="table-input num-input w-32" value="${item.buyUSD}" onchange="updGame('${item.docId}','buyUSD',this.value)"></td>
                    <td class="px-3 py-2 text-right font-mono text-red-600 bg-red-50/50 rounded">${costDA.toFixed(0)}</td>
                    <td class="px-3 py-2 text-right font-mono text-blue-600 bg-blue-50/50 rounded">${(currentRate>0?item.sellDA/currentRate:0).toFixed(2)}</td>
                    <td class="px-3 py-2"><input class="table-input num-input font-bold text-green-700 w-32" value="${item.sellDA}" onchange="updGame('${item.docId}','sellDA',this.value)"></td>
                    <td class="px-3 py-2 text-right font-bold ${profit>=0?'text-indigo-600':'text-red-500'}">${profit.toFixed(0)}</td>
                    <td class="px-3 py-2 text-right text-xs">${(item.sellDA>0?(profit/item.sellDA*100):0).toFixed(0)}%</td>
                    <td class="px-3 py-2 text-right whitespace-nowrap">${btns}</td>`;
                if(gamesFilters.provider==='all' && gamesFilters.game==='all') addDragEvents(tr, idx); else tr.querySelector('.drag-handle').classList.add('opacity-0','pointer-events-none');
                tbody.appendChild(tr);
            });
            updateKPIs(tCostUSD, tCostDA, tRev, tProfit);
        }

        // --- CANVA LOGIC ---
        function updateCanvaDashboard() {
            if(currentView !== 'canva') return;
            let tCostUSD=0, tCostDA=0, tRev=0, tProfit=0;
            const tbody = document.getElementById('canvaTableBody'); tbody.innerHTML = '';
            if(canvaData.length === 0) tbody.innerHTML = '<tr><td colspan="12" class="text-center py-8 text-slate-400">No subscriptions.</td></tr>';

            canvaData.forEach(item => {
                const costDA = item.buyDA !== undefined ? item.buyDA : (item.buyUSD * currentRate);
                const costUSD = currentRate > 0 ? (costDA / currentRate) : 0;
                const profit = item.sellDA - costDA;
                tCostUSD += costUSD; tCostDA += costDA; tRev += item.sellDA; tProfit += profit;
                
                const tr = document.createElement('tr'); tr.className = "hover:bg-slate-50 border-b border-slate-100 last:border-0";
                tr.innerHTML = `
                    <td class="px-3 py-2 text-center text-xs text-slate-400 font-mono"><input class="table-input num-input text-xs text-slate-400 w-24" value="${item.customId||'Auto'}" onchange="updCanva('${item.docId}','customId',this.value)"></td>
                    <td class="px-3 py-2"><input class="table-input font-medium" value="${item.name}" onchange="updCanva('${item.docId}','name',this.value)"></td>
                    <td class="px-3 py-2"><input class="table-input text-slate-500" value="${item.email}" onchange="updCanva('${item.docId}','email',this.value)"></td>
                    <td class="px-3 py-2"><input type="date" class="table-input text-xs" value="${item.startDate}" onchange="updCanva('${item.docId}','startDate',this.value)"></td>
                    <td class="px-3 py-2"><input type="date" class="table-input text-xs" value="${item.endDate}" onchange="updCanva('${item.docId}','endDate',this.value)"></td>
                    <td class="px-3 py-2 text-right font-mono text-slate-500 w-32">${costUSD.toFixed(2)}</td>
                    <td class="px-3 py-2"><input class="table-input num-input font-bold text-red-600 bg-red-50/50 w-24" value="${costDA}" onchange="updCanva('${item.docId}','buyDA',this.value)"></td>
                    <td class="px-3 py-2 text-right font-mono text-blue-600 bg-blue-50/50 rounded">${(currentRate>0?item.sellDA/currentRate:0).toFixed(2)}</td>
                    <td class="px-3 py-2"><input class="table-input num-input font-bold text-green-700 w-32" value="${item.sellDA}" onchange="updCanva('${item.docId}','sellDA',this.value)"></td>
                    <td class="px-3 py-2 text-right font-bold ${profit>=0?'text-indigo-600':'text-red-500'}">${profit.toFixed(0)}</td>
                    <td class="px-3 py-2 text-right text-xs">${(item.sellDA>0?(profit/item.sellDA*100):0).toFixed(0)}%</td>
                    <td class="px-3 py-2 text-right"><button onclick="window.delCanva('${item.docId}')" class="text-red-500 hover:bg-red-50 p-1 rounded">&times;</button></td>
                `;
                tbody.appendChild(tr);
            });
            updateKPIs(tCostUSD, tCostDA, tRev, tProfit);
        }

        // --- HELPERS ---
        function updateKPIs(usd, da, rev, profit) {
            document.getElementById('kpi-cost-usd').textContent = '$' + usd.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('kpi-cost-da').textContent = da.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('kpi-revenue').textContent = rev.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('kpi-profit').textContent = profit.toLocaleString(undefined, {maximumFractionDigits: 0});
            const margin = rev > 0 ? (profit/rev)*100 : 0;
            document.getElementById('kpi-margin').textContent = margin.toFixed(1) + '%';
        }

        function toggleSidebar(show) {
            const sb = document.getElementById('sidebar'); const ol = document.getElementById('sidebar-overlay');
            if(show) { sb.classList.remove('-translate-x-full'); ol.classList.remove('hidden'); }
            else { sb.classList.add('-translate-x-full'); ol.classList.add('hidden'); }
        }

        window.updSMM = async (id, f, v) => { let val=v; if(['buyUSD','sellDA','qty','customId'].includes(f)) val=parseFloat(v)||0; await updateDoc(doc(db,'artifacts',appId,'users',userId,'services',id), {[f]:val}); };
        window.delSMM = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db,'artifacts',appId,'users',userId,'services',id)); };
        window.dupSMM = async (id) => { const item=smmData.find(i=>i.docId===id); const newItem={...item,customId:(Math.max(...smmData.map(i=>i.customId||0)))+1,sortOrder:smmData.length,createdAt:Date.now()}; delete newItem.docId; await addDoc(collection(db,'artifacts',appId,'users',userId,'services'),newItem); };
        window.updCanva = async (id, f, v) => { let val=v; if(['buyUSD','sellDA','customId','buyDA'].includes(f)) val=parseFloat(v)||0; await updateDoc(doc(db,'artifacts',appId,'users',userId,'canva_services',id), {[f]:val}); };
        window.delCanva = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db,'artifacts',appId,'users',userId,'canva_services',id)); };
        window.updGame = async (id, f, v) => { let val=v; if(['buyUSD','sellDA','customId'].includes(f)) val=parseFloat(v)||0; await updateDoc(doc(db,'artifacts',appId,'users',userId,'games_services',id), {[f]:val}); };
        window.delGame = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db,'artifacts',appId,'users',userId,'games_services',id)); };

        // --- CHARTS & DRAG ---
        function initCharts() {
            if(!document.getElementById('smmChart')) return;
            Chart.defaults.font.family = "'Inter', sans-serif";
            smmChart = new Chart(document.getElementById('smmChart').getContext('2d'), { type: 'bar', data: { labels:[], datasets:[{label:'Cost',data:[],backgroundColor:'#cbd5e1'},{label:'Sell',data:[],backgroundColor:'#6366f1'}] }, options: { maintainAspectRatio:false, scales:{x:{grid:{display:false}},y:{beginAtZero:true}} } });
            smmDistChart = new Chart(document.getElementById('smmDistChart').getContext('2d'), { type: 'doughnut', data: { labels:[], datasets:[{data:[],backgroundColor:['#6366f1','#818cf8','#a5b4fc']}] }, options: { maintainAspectRatio:false, cutout:'70%' } });
        }
        function updateCharts(data) {
            if(!smmChart) return;
            const top = [...data].sort((a,b)=> (b.sellDA-(b.buyUSD*currentRate)) - (a.sellDA-(a.buyUSD*currentRate))).slice(0,5);
            smmChart.data.labels = top.map(i=>i.service.substring(0,10)); smmChart.data.datasets[0].data = top.map(i=>i.buyUSD*currentRate); smmChart.data.datasets[1].data = top.map(i=>i.sellDA); smmChart.update();
            const plats = [...new Set(data.map(i=>i.platform))]; smmDistChart.data.labels = plats; smmDistChart.data.datasets[0].data = plats.map(p=>data.filter(i=>i.platform===p).length); smmDistChart.update();
        }
        function addDragEvents(row, idx) {
            row.setAttribute('draggable','false'); row.dataset.index = idx;
            const h = row.querySelector('.drag-handle');
            h.onmouseenter=()=>row.setAttribute('draggable','true'); h.onmouseleave=()=>row.setAttribute('draggable','false'); h.onmousedown=()=>row.setAttribute('draggable','true');
            row.ondragstart = (e) => { dragSrcEl=row; dragSrcIndex=idx; row.classList.add('dragging'); e.dataTransfer.setData('text/plain', idx); };
            row.ondragover = (e) => { e.preventDefault(); return false; };
            row.ondragend = () => { row.classList.remove('dragging'); row.setAttribute('draggable','false'); };
            row.ondrop = async (e) => {
                e.stopPropagation();
                let allow = false;
                if(currentView === 'smm' && smmFilters.platform==='all' && smmFilters.category==='all') allow = true;
                if(currentView === 'games' && gamesFilters.provider==='all' && gamesFilters.game==='all') allow = true;
                
                if(!allow) { alert("Please clear filters to reorder items."); return false; }
                
                const toIdx = parseInt(row.dataset.index);
                if(dragSrcIndex > -1 && dragSrcIndex !== toIdx) {
                    await reorderItems(dragSrcIndex, toIdx);
                }
            };
        }

        async function reorderItems(fromIndex, toIndex) {
            let list, collectionName;
            if (currentView === 'smm') { list = smmData; collectionName = 'services'; }
            else if (currentView === 'games') { list = gamesData; collectionName = 'games_services'; }
            else return;

            const itemMoved = list.splice(fromIndex, 1)[0];
            list.splice(toIndex, 0, itemMoved);
            
            // Batch update
            const batch = writeBatch(db);
            list.forEach((item, index) => {
                 item.sortOrder = index;
                 if (item.docId) {
                     const ref = doc(db, 'artifacts', appId, 'users', userId, collectionName, item.docId);
                     batch.update(ref, { sortOrder: index });
                 }
            });
            try { await batch.commit(); } catch(err) { console.error("Reorder failed", err); }
        }
    </script>
</body>
</html>
